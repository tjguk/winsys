
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>fs &#8212; WinSys 1.0beta documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../contents.html">WinSys 1.0beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for fs</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Provide a wrapper around common filesystem operations, including</span>
<span class="sd">iterating over the files in a directory structure and copying,</span>
<span class="sd">moving and linking them. Wherever possible iterators are used,</span>
<span class="sd">making it possible to act on large directory structures without</span>
<span class="sd">loading them all into memory.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">msvcrt</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="kn">import</span> <span class="nn">ntsecuritycon</span>
<span class="kn">import</span> <span class="nn">pywintypes</span>
<span class="kn">import</span> <span class="nn">winerror</span>
<span class="kn">import</span> <span class="nn">win32api</span>
<span class="kn">import</span> <span class="nn">win32con</span>
<span class="kn">import</span> <span class="nn">win32event</span>
<span class="kn">import</span> <span class="nn">win32file</span>
<span class="kn">import</span> <span class="nn">win32net</span>
<span class="kn">import</span> <span class="nn">win32netcon</span>
<span class="kn">import</span> <span class="nn">winioctlcon</span>


<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">winerror</span><span class="p">,</span> <span class="s1">&#39;ERROR_BAD_RECOVERY_POLICY&#39;</span><span class="p">):</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_BAD_RECOVERY_POLICY</span> <span class="o">=</span> <span class="mi">6012</span>

<span class="kn">from</span> <span class="nn">winsys._compat</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">winsys</span> <span class="kn">import</span> <span class="n">constants</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">handles</span><span class="p">,</span> <span class="n">security</span> <span class="k">as</span> <span class="n">security_</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">_kernel32</span>

<span class="n">sep</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
<span class="n">seps</span> <span class="o">=</span> <span class="s2">&quot;/</span><span class="se">\\</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="x_fs"><a class="viewcode-back" href="../fs.html#fs.x_fs">[docs]</a><span class="k">class</span> <span class="nc">x_fs</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">x_winsys</span><span class="p">):</span>
    <span class="s2">&quot;Base for all fs-related exceptions&quot;</span></div>

<div class="viewcode-block" id="x_no_such_file"><a class="viewcode-back" href="../fs.html#fs.x_no_such_file">[docs]</a><span class="k">class</span> <span class="nc">x_no_such_file</span><span class="p">(</span><span class="n">x_fs</span><span class="p">):</span>
    <span class="s2">&quot;Raised when a file could not be found&quot;</span></div>

<div class="viewcode-block" id="x_too_many_files"><a class="viewcode-back" href="../fs.html#fs.x_too_many_files">[docs]</a><span class="k">class</span> <span class="nc">x_too_many_files</span><span class="p">(</span><span class="n">x_fs</span><span class="p">):</span>
    <span class="s2">&quot;Raised when more than one file matches a name&quot;</span></div>

<div class="viewcode-block" id="x_invalid_name"><a class="viewcode-back" href="../fs.html#fs.x_invalid_name">[docs]</a><span class="k">class</span> <span class="nc">x_invalid_name</span><span class="p">(</span><span class="n">x_fs</span><span class="p">):</span>
    <span class="s2">&quot;Raised when a filename contains invalid characters&quot;</span></div>

<div class="viewcode-block" id="x_no_certificate"><a class="viewcode-back" href="../fs.html#fs.x_no_certificate">[docs]</a><span class="k">class</span> <span class="nc">x_no_certificate</span><span class="p">(</span><span class="n">x_fs</span><span class="p">):</span>
    <span class="s2">&quot;Raised when encryption is attempted without a certificate&quot;</span></div>

<div class="viewcode-block" id="x_not_ready"><a class="viewcode-back" href="../fs.html#fs.x_not_ready">[docs]</a><span class="k">class</span> <span class="nc">x_not_ready</span><span class="p">(</span><span class="n">x_fs</span><span class="p">):</span>
    <span class="s2">&quot;Raised when a device is not ready&quot;</span></div>

<span class="k">class</span> <span class="nc">x_sharing_violation</span><span class="p">(</span><span class="n">x_fs</span><span class="p">):</span>
    <span class="s2">&quot;Raised when a sharing violation occurs&quot;</span>

<span class="n">WINERROR_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_ACCESS_DENIED</span> <span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_access_denied</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_PATH_NOT_FOUND</span> <span class="p">:</span> <span class="n">x_no_such_file</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_FILE_NOT_FOUND</span> <span class="p">:</span> <span class="n">x_no_such_file</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_BAD_NETPATH</span> <span class="p">:</span> <span class="n">x_no_such_file</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_INVALID_NAME</span> <span class="p">:</span> <span class="n">x_invalid_name</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_BAD_RECOVERY_POLICY</span> <span class="p">:</span> <span class="n">x_no_certificate</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_NOT_READY</span> <span class="p">:</span> <span class="n">x_not_ready</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_INVALID_HANDLE</span> <span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_invalid_handle</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_SHARING_VIOLATION</span> <span class="p">:</span> <span class="n">x_sharing_violation</span><span class="p">,</span>
    <span class="mi">2310</span> <span class="p">:</span> <span class="n">x_no_such_file</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">wrapped</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">WINERROR_MAP</span><span class="p">,</span> <span class="n">x_fs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ignore_access_errors</span><span class="p">(</span><span class="n">exc_info</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_access_denied</span>

<span class="n">PyHANDLE</span> <span class="o">=</span> <span class="n">pywintypes</span><span class="o">.</span><span class="n">HANDLEType</span>

<span class="n">FILE_ACCESS</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;FILE_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">ntsecuritycon</span><span class="p">)</span>
<span class="n">FILE_ACCESS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">STANDARD_ACCESS</span><span class="p">)</span>
<span class="n">FILE_ACCESS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">GENERIC_ACCESS</span><span class="p">)</span>
<span class="n">FILE_ACCESS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">ACCESS</span><span class="p">)</span>
<span class="n">FILE_ACCESS</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;File-specific access rights&quot;</span><span class="p">)</span>

<span class="n">FILE_SHARE</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;FILE_SHARE_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32file</span><span class="p">)</span>
<span class="n">FILE_SHARE</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Ways of sharing a file for reading, writing, &amp;c.&quot;</span><span class="p">)</span>

<span class="n">FILE_CREATION</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_list</span><span class="p">([</span>
    <span class="s2">&quot;CREATE_ALWAYS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CREATE_NEW&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OPEN_ALWAYS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;OPEN_EXISTING&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRUNCATE_EXISTING&quot;</span>
<span class="p">],</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32con</span><span class="p">)</span>
<span class="n">FILE_CREATION</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Options when creating a file&quot;</span><span class="p">)</span>

<span class="n">FILE_FLAG</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;FILE_FLAG_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32con</span><span class="p">)</span>
<span class="n">FILE_FLAG</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;File flags&quot;</span><span class="p">)</span>

<span class="n">FILE_NOTIFY_CHANGE</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;FILE_NOTIFY_CHANGE_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32con</span><span class="p">)</span>
<span class="n">FILE_NOTIFY_CHANGE</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Notification types to watch for when a file changes&quot;</span><span class="p">)</span>
<span class="n">FILE_ACTION</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">ADDED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">REMOVED</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">MODIFIED</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">RENAMED_OLD_NAME</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">RENAMED_NEW_NAME</span> <span class="o">=</span> <span class="mi">5</span>
<span class="p">))</span>
<span class="n">FILE_ACTION</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Results of a file change&quot;</span><span class="p">)</span>
<span class="n">FILE_ATTRIBUTE</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;FILE_ATTRIBUTE_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32file</span><span class="p">)</span>
<span class="n">FILE_ATTRIBUTE</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">ENCRYPTED</span><span class="o">=</span><span class="mh">0x00004000</span><span class="p">,</span>
    <span class="n">REPARSE_POINT</span><span class="o">=</span><span class="mh">0x00000400</span><span class="p">,</span>
    <span class="n">SPARSE_FILE</span><span class="o">=</span><span class="mh">0x00000200</span><span class="p">,</span>
    <span class="n">VIRTUAL</span><span class="o">=</span><span class="mh">0x00010000</span><span class="p">,</span>
    <span class="n">NOT_CONTENT_INDEXES</span><span class="o">=</span><span class="mh">0x00002000</span><span class="p">,</span>
<span class="p">))</span>
<span class="n">FILE_ATTRIBUTE</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Attributes applying to any file&quot;</span><span class="p">)</span>
<span class="n">PROGRESS</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;PROGRESS_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32file</span><span class="p">)</span>
<span class="n">PROGRESS</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;States within a file move/copy progress&quot;</span><span class="p">)</span>
<span class="n">MOVEFILE</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;MOVEFILE_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32file</span><span class="p">)</span>
<span class="n">MOVEFILE</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Options when moving a file&quot;</span><span class="p">)</span>
<span class="n">VOLUME_FLAG</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
  <span class="n">FILE_CASE_SENSITIVE_SEARCH</span>      <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>
  <span class="n">FILE_CASE_PRESERVED_NAMES</span>       <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>
  <span class="n">FILE_UNICODE_ON_DISK</span>            <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>
  <span class="n">FILE_PERSISTENT_ACLS</span>            <span class="o">=</span> <span class="mh">0x00000008</span><span class="p">,</span>
  <span class="n">FILE_FILE_COMPRESSION</span>           <span class="o">=</span> <span class="mh">0x00000010</span><span class="p">,</span>
  <span class="n">FILE_VOLUME_QUOTAS</span>              <span class="o">=</span> <span class="mh">0x00000020</span><span class="p">,</span>
  <span class="n">FILE_SUPPORTS_SPARSE_FILES</span>      <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">,</span>
  <span class="n">FILE_SUPPORTS_REPARSE_POINTS</span>    <span class="o">=</span> <span class="mh">0x00000080</span><span class="p">,</span>
  <span class="n">FILE_SUPPORTS_REMOTE_STORAGE</span>    <span class="o">=</span> <span class="mh">0x00000100</span><span class="p">,</span>
  <span class="n">FILE_VOLUME_IS_COMPRESSED</span>       <span class="o">=</span> <span class="mh">0x00008000</span><span class="p">,</span>
  <span class="n">FILE_SUPPORTS_OBJECT_IDS</span>        <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">,</span>
  <span class="n">FILE_SUPPORTS_ENCRYPTION</span>        <span class="o">=</span> <span class="mh">0x00020000</span><span class="p">,</span>
  <span class="n">FILE_NAMED_STREAMS</span>              <span class="o">=</span> <span class="mh">0x00040000</span><span class="p">,</span>
  <span class="n">FILE_READ_ONLY_VOLUME</span>           <span class="o">=</span> <span class="mh">0x00080000</span><span class="p">,</span>
  <span class="n">FILE_SEQUENTIAL_WRITE_ONCE</span>      <span class="o">=</span> <span class="mh">0x00100000</span><span class="p">,</span>
  <span class="n">FILE_SUPPORTS_TRANSACTIONS</span>      <span class="o">=</span> <span class="mh">0x00200000</span>
<span class="p">),</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FILE_*&quot;</span><span class="p">)</span>
<span class="n">VOLUME_FLAG</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Characteristics of a volume&quot;</span><span class="p">)</span>
<span class="n">DRIVE_TYPE</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;DRIVE_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32file</span><span class="p">)</span>
<span class="n">DRIVE_TYPE</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Types of drive&quot;</span><span class="p">)</span>
<span class="n">COMPRESSION_FORMAT</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">NONE</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
    <span class="n">DEFAULT</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>
    <span class="n">LZNT1</span> <span class="o">=</span> <span class="mh">0x0002</span>
<span class="p">))</span>
<span class="n">COMPRESSION_FORMAT</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Ways in which a file can be compressed&quot;</span><span class="p">)</span>
<span class="n">FSCTL</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;FSCTL_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">winioctlcon</span><span class="p">)</span>
<span class="n">FSCTL</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Types of fsctl operation&quot;</span><span class="p">)</span>
<span class="n">STYPE</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_pattern</span><span class="p">(</span><span class="s2">&quot;STYPE_*&quot;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32netcon</span><span class="p">)</span>

<span class="n">PyHANDLE</span> <span class="o">=</span> <span class="n">pywintypes</span><span class="o">.</span><span class="n">HANDLEType</span>

<span class="n">LEGAL_FILECHAR</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[^\?\*</span><span class="se">\\</span><span class="s2">\:\/]&quot;</span>
<span class="n">LEGAL_FILECHARS</span> <span class="o">=</span> <span class="n">LEGAL_FILECHAR</span> <span class="o">+</span> <span class="s2">&quot;+&quot;</span>
<span class="n">LEGAL_VOLCHAR</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[^\?\*</span><span class="se">\\</span><span class="s2">\/]&quot;</span>
<span class="n">LEGAL_VOLCHARS</span> <span class="o">=</span> <span class="n">LEGAL_VOLCHAR</span> <span class="o">+</span> <span class="s2">&quot;+&quot;</span>
<span class="n">UNC</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">LEGAL_FILECHARS</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">LEGAL_FILECHARS</span>
<span class="n">HEXDIGIT</span> <span class="o">=</span> <span class="s2">&quot;[0-9a-f]&quot;</span>
<span class="n">DRIVE</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[A-Za-z]:&quot;</span>
<span class="n">VOLUME_PREAMBLE</span> <span class="o">=</span> <span class="n">sep</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\?&quot;</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">VOLUME</span> <span class="o">=</span> <span class="n">VOLUME_PREAMBLE</span> <span class="o">+</span> <span class="s2">&quot;Volume\{</span><span class="si">%s{8}</span><span class="s2">-</span><span class="si">%s{4}</span><span class="s2">-</span><span class="si">%s{4}</span><span class="s2">-</span><span class="si">%s{4}</span><span class="s2">-</span><span class="si">%s{12}</span><span class="s2">\}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">HEXDIGIT</span><span class="p">,</span> <span class="n">HEXDIGIT</span><span class="p">,</span> <span class="n">HEXDIGIT</span><span class="p">,</span> <span class="n">HEXDIGIT</span><span class="p">,</span> <span class="n">HEXDIGIT</span><span class="p">)</span>
<span class="n">DRIVE_VOLUME</span> <span class="o">=</span> <span class="n">VOLUME_PREAMBLE</span> <span class="o">+</span> <span class="n">DRIVE</span>
<span class="n">PREFIX</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;((?:</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">)</span><span class="se">\\</span><span class="s2">?)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">UNC</span><span class="p">,</span> <span class="n">DRIVE</span><span class="p">,</span> <span class="n">VOLUME</span><span class="p">,</span> <span class="n">DRIVE_VOLUME</span><span class="p">)</span>
<span class="n">PATHSEG</span> <span class="o">=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">LEGAL_FILECHARS</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;?&quot;</span>
<span class="n">PATHSEGS</span> <span class="o">=</span> <span class="s2">&quot;(?:</span><span class="si">%s</span><span class="s2">)*&quot;</span> <span class="o">%</span> <span class="n">PATHSEG</span>
<span class="n">FILEPATH</span> <span class="o">=</span> <span class="n">PREFIX</span> <span class="o">+</span> <span class="n">PATHSEGS</span>

<div class="viewcode-block" id="get_parts"><a class="viewcode-back" href="../fs.html#fs.get_parts">[docs]</a><span class="k">def</span> <span class="nf">get_parts</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Helper function to regularise a file path and then</span>
<span class="sd">    to pick out its drive and path components.</span>

<span class="sd">    Attempt to match the first part of the string against</span>
<span class="sd">    known path leaders::</span>

<span class="sd">        &lt;drive&gt;:\</span>
<span class="sd">        \\?\&lt;drive&gt;:\</span>
<span class="sd">        \\?\Volume{xxxx-...}\</span>
<span class="sd">        \\server\share\</span>

<span class="sd">    If that fails, assume the path is relative.</span>

<span class="sd">    ============================= ======================================</span>
<span class="sd">    Path                                                    Parts</span>
<span class="sd">    ============================= ======================================</span>
<span class="sd">    c:/                           [&quot;c:\\&quot;, &quot;&quot;]</span>
<span class="sd">    c:/t                          [&quot;c:\\&quot;, &quot;t&quot;]</span>
<span class="sd">    c:/t/                         [&quot;c:\\&quot;, &quot;t&quot;]</span>
<span class="sd">    c:/t/test.txt                 [&quot;c:\\&quot;, &quot;t&quot;, &quot;test.txt&quot;]</span>
<span class="sd">    c:/t/s/test.txt               [&quot;c:\\&quot;, &quot;t&quot;, &quot;s&quot;, &quot;test.txt&quot;]</span>
<span class="sd">    c:test.txt                    [&quot;c:&quot;, &quot;test.txt&quot;]</span>
<span class="sd">    s/test.txt                    [&quot;&quot;, &quot;s&quot;, &quot;test.txt&quot;]</span>
<span class="sd">    \\\\server\\share             [&quot;\\\\server\\share\\&quot;, &quot;&quot;]</span>
<span class="sd">    \\\\server\\share\\a.txt      [&quot;\\\\server\\share\\&quot;, &quot;a.txt&quot;]</span>
<span class="sd">    \\\\server\\share\\t\\a.txt   [&quot;\\\\server\\share\\&quot;, &quot;t&quot;, &quot;a.txt&quot;]</span>
<span class="sd">    \\\\?\\c:\test.txt            [&quot;\\\\?\\c:\\&quot;, &quot;test.txt&quot;]</span>
<span class="sd">    \\\\?\\Volume{xxxx-..}\\t.txt [&quot;\\\\?\Volume{xxxx-..}\\&quot;, &quot;t.txt&quot;]</span>
<span class="sd">    ============================= ======================================</span>

<span class="sd">    The upshot is that the first item in the list returned is</span>
<span class="sd">    always the root, one of: a slash-terminated drive/volume/share</span>
<span class="sd">    for an absolute path; an empty string for a relative path; or</span>
<span class="sd">    a drive-colon for a drive-relative path.</span>

<span class="sd">    All other items before the last one represent the directories along</span>
<span class="sd">    the way. The last item is the filename or directory name.</span>

<span class="sd">    The original filepath can usually be reconstructed as::</span>

<span class="sd">        from winsys import fs</span>
<span class="sd">        filepath = &quot;c:/temp/abc.txt&quot;</span>
<span class="sd">        parts = fs.get_parts(filepath)</span>
<span class="sd">        assert parts[0] + &quot;\\&quot;.join(parts[1:]) == filepath</span>

<span class="sd">    The exception is when a root (UNC or volume) is given without</span>
<span class="sd">    a trailing slash. This is added in. Or if a directory is given</span>
<span class="sd">    with a trailing slash. This is stripped off.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">)</span>
    <span class="n">prefix_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">PREFIX</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prefix_match</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rest</span> <span class="o">=</span> <span class="n">filepath</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># Special-case the un-rooted drive letter</span>
        <span class="c1"># so that paths of the form &lt;drive&gt;:&lt;path&gt;</span>
        <span class="c1"># are still valid, indicating &lt;path&gt; in the</span>
        <span class="c1"># current directory on &lt;drive&gt;</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="o">+</span> <span class="n">sep</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">+</span> <span class="n">rest</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span></div>

<div class="viewcode-block" id="normalised"><a class="viewcode-back" href="../fs.html#fs.normalised">[docs]</a><span class="k">def</span> <span class="nf">normalised</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert any path or path-like object into the</span>
<span class="sd">    length-unlimited unicode equivalent. This should avoid</span>
<span class="sd">    issues with maximum path length and the like.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># os.path.abspath will return a sep-terminated string</span>
    <span class="c1"># for the root directory and a non-sep-terminated</span>
    <span class="c1"># string for all other paths.</span>
    <span class="c1">#</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sep</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">filepath</span>
    <span class="k">elif</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">filepath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">is_dir</span> <span class="o">=</span> <span class="n">filepath</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">seps</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">?</span><span class="se">\\</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">abspath</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sep</span> <span class="k">if</span> <span class="n">is_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">abspath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">handle</span><span class="p">):</span>
    <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>

<div class="viewcode-block" id="handle"><a class="viewcode-back" href="../fs.html#fs.handle">[docs]</a><span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_async</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a file handle either for querying</span>
<span class="sd">    (the default case) or for writing -- including writing directories</span>

<span class="sd">    :param filepath: anything whose unicode representation is a valid file path</span>
<span class="sd">    :param write: is the handle to be used for writing [True]</span>
<span class="sd">    :param attributes: anything accepted by :const:`FILE_ATTRIBUTE`</span>
<span class="sd">    :return: an open file handle for reading or writing, including directories</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">FILE_ATTRIBUTE</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">FILE_ATTRIBUTE</span><span class="o">.</span><span class="n">NORMAL</span> <span class="o">|</span> <span class="n">FILE_FLAG</span><span class="o">.</span><span class="n">BACKUP_SEMANTICS</span>
    <span class="k">if</span> <span class="n">use_async</span><span class="p">:</span>
        <span class="n">attributes</span> <span class="o">|=</span> <span class="n">FILE_FLAG</span><span class="o">.</span><span class="n">OVERLAPPED</span>
    <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span>
        <span class="n">win32file</span><span class="o">.</span><span class="n">CreateFile</span><span class="p">,</span>
        <span class="n">normalised</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span>
        <span class="p">(</span><span class="n">FILE_ACCESS</span><span class="o">.</span><span class="n">READ</span> <span class="o">|</span> <span class="n">FILE_ACCESS</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span> <span class="k">if</span> <span class="n">write</span> <span class="k">else</span> <span class="n">FILE_ACCESS</span><span class="o">.</span><span class="n">READ</span><span class="p">,</span>
        <span class="mi">0</span> <span class="k">if</span> <span class="n">exclusive</span> <span class="k">else</span> <span class="p">(</span><span class="n">FILE_SHARE</span><span class="o">.</span><span class="n">READ</span> <span class="o">|</span> <span class="n">FILE_SHARE</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span> <span class="k">if</span> <span class="n">write</span> <span class="k">else</span> <span class="n">FILE_SHARE</span><span class="o">.</span><span class="n">READ</span><span class="p">,</span>
        <span class="n">sec</span><span class="p">,</span>
        <span class="n">FILE_CREATION</span><span class="o">.</span><span class="n">OPEN_ALWAYS</span> <span class="k">if</span> <span class="n">write</span> <span class="k">else</span> <span class="n">FILE_CREATION</span><span class="o">.</span><span class="n">OPEN_EXISTING</span><span class="p">,</span>
        <span class="n">attributes</span><span class="p">,</span>
        <span class="kc">None</span>
    <span class="p">)</span></div>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">handle_or_filepath</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the handle passed or on newly-created for</span>
<span class="sd">    the filepath, making sure to close it afterwards.</span>

<span class="sd">    :param handle_or_filepath: an existing handle or something accepted by :func:`handle`</span>
<span class="sd">    :param write: passed through to :func:`handle`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle_or_filepath</span><span class="p">,</span> <span class="n">PyHANDLE</span><span class="p">):</span>
        <span class="n">handle_supplied</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">hFile</span> <span class="o">=</span> <span class="n">handle_or_filepath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">handle_supplied</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hFile</span> <span class="o">=</span> <span class="n">handle</span><span class="p">(</span><span class="n">handle_or_filepath</span><span class="p">,</span> <span class="n">write</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">hFile</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">handle_supplied</span><span class="p">:</span>
        <span class="n">hFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="relative_to"><a class="viewcode-back" href="../fs.html#fs.relative_to">[docs]</a><span class="k">def</span> <span class="nf">relative_to</span><span class="p">(</span><span class="n">filepath1</span><span class="p">,</span> <span class="n">filepath2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return filepath2 relative to filepath1. Both names</span>
<span class="sd">    are normalised first.</span>

<span class="sd">    ================ ================ ================</span>
<span class="sd">    filepath1        filepath2        result</span>
<span class="sd">    ================ ================ ================</span>
<span class="sd">    c:/a/b.txt       c:/a             b.txt</span>
<span class="sd">    ---------------- ---------------- ----------------</span>
<span class="sd">    c:/a/b/c.txt     c:/a             b/c.txt</span>
<span class="sd">    ---------------- ---------------- ----------------</span>
<span class="sd">    c:/a/b/c.txt     c:/a/b           c.txt</span>
<span class="sd">    ================ ================ ================</span>

<span class="sd">    :param filepath1: a file or directory</span>
<span class="sd">    :param filepath2: a directory</span>
<span class="sd">    :returns: filepath2 relative to filepath1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># filepath2 must always be a directory; filepath1 may</span>
    <span class="c1"># be a file or a directory.</span>
    <span class="c1">#</span>
    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">filepath1</span><span class="p">,</span> <span class="n">filepath2</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">seps</span><span class="p">)</span> <span class="o">+</span> <span class="n">sep</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilePath"><a class="viewcode-back" href="../fs_filepath.html#fs.FilePath">[docs]</a><span class="k">class</span> <span class="nc">FilePath</span><span class="p">(</span><span class="n">unicode</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;A unicode subtype which knows about path structures on Windows.</span>
<span class="sd">    The path itself need not exist on any filesystem, but it has to match</span>
<span class="sd">    the rules which would make it possible.</span>

<span class="sd">    FilePaths can be absolute or relative. The only difference is that</span>
<span class="sd">    the root attribute is empty for relative paths. They can be added</span>
<span class="sd">    to each other or to other unicode strings which will use os.path.join</span>
<span class="sd">    semantics.</span>

<span class="sd">    A FilePath offers quick access to the different parts of the path:</span>

<span class="sd">    * parts - a list of the components (cf :func:`fs.get_parts`)</span>
<span class="sd">    * root - the drive or UNC server/share ending in a backslash unless a drive-relative path</span>
<span class="sd">    * filename - final component</span>
<span class="sd">    * name - same as filename (convenience)</span>
<span class="sd">    * dirname - all path components before the last</span>
<span class="sd">    * path - combination of root and dirname</span>
<span class="sd">    * parent - combination of root and all path components before second penultimate; raises</span>
<span class="sd">        an exception is FilePath is relative.</span>
<span class="sd">    * base - base part of filename (ie the piece before the dot)</span>
<span class="sd">    * ext - ext part of filename (ie the dot and the piece after)</span>

<span class="sd">    =================== ========== ========= ========= ========= =========== =========== ===== ====</span>
<span class="sd">    Path                root       filename  name      dirname   path        parent      base  ext</span>
<span class="sd">    =================== ========== ========= ========= ========= =========== =========== ===== ====</span>
<span class="sd">    \\\\a\b\c\d.txt     \\\\a\b\   d.txt     d.txt     c         \\\\a\b\c   \\\\a\b\c d       .txt</span>
<span class="sd">    c:\\boot.ini        c:\\       boot.ini  boot.ini  _         c:\\        c:\\        boot  .ini</span>
<span class="sd">    boot.ini            _          boot.ini  boot.ini  _         _           x_fs        boot  .ini</span>
<span class="sd">    c:\\t               c:\\       t         t         _         c:\\        c:\\        t     _</span>
<span class="sd">    c:\\t\              c:\\       t         t         _         c:\\        c:\\        t     _</span>
<span class="sd">    c:\\t\a.txt         c:\\       a.txt     a.txt     t         c:\\t       c:\\t       a     .txt</span>
<span class="sd">    c:a.txt             c:         a.txt     a.txt     _         c:          x_fs        a     .txt</span>
<span class="sd">    a.txt               _          a.txt     a.txt     _         _           x_fs        a     .txt</span>
<span class="sd">    =================== ========== ========= ========= ========= =========== =========== ===== ====</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">unicode</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">))</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_parts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_dirname</span><span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_base</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_ext</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">fp</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">dumped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;parts: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;root: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;dirname: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;path: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;filename: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;base: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ext: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;parent: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">level</span><span class="p">)</span>

<div class="viewcode-block" id="FilePath.factory"><a class="viewcode-back" href="../fs_filepath.html#fs.FilePath.factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Designed to be redefined in a subclass so that the :meth:`__add__` and :meth:`__radd__`</span>
<span class="sd">        methods can return the appropriate type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Have FilepathA + FilepathB return FilepathA/FilepathB::</span>

<span class="sd">        from winsys import fs</span>

<span class="sd">        fs.dir(r&quot;c:\windows&quot;) + &quot;notepad.exe&quot;</span>
<span class="sd">        # returns fs.File(&quot;c:/windows/notepad.exe&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">unicode</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Files compare equal if their case-insensitive paths are equal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">unicode</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Entries hash equal equal if their case-insensitive paths hash equal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_get_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span> <span class="o">=</span> <span class="n">get_parts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parts</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_root</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dirname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirname</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirname</span>
    <span class="n">dirname</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_dirname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">factory</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_relative</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">x_fs</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;FilePath.parent&quot;</span><span class="p">,</span> <span class="s2">&quot;Cannot find parent for relative path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent_dir</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span> <span class="k">if</span> <span class="n">p</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parent_dir</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_parent</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
    <span class="n">name</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_base</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ext</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_ext</span><span class="p">)</span>

<div class="viewcode-block" id="FilePath.is_relative"><a class="viewcode-back" href="../fs_filepath.html#fs.FilePath.is_relative">[docs]</a>    <span class="k">def</span> <span class="nf">is_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A filepath is relative if it has no root or if its</span>
<span class="sd">        root is a drive letter only (without a directory backslash).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilePath.relative_to"><a class="viewcode-back" href="../fs_filepath.html#fs.FilePath.relative_to">[docs]</a>    <span class="k">def</span> <span class="nf">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return this filepath as relative to another. cf :func:`utils.relative_to`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unicode</span><span class="p">(</span><span class="n">other</span><span class="p">)))</span></div>

<div class="viewcode-block" id="FilePath.absolute"><a class="viewcode-back" href="../fs_filepath.html#fs.FilePath.absolute">[docs]</a>    <span class="k">def</span> <span class="nf">absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an absolute version of the current FilePath, whether</span>
<span class="sd">        relative or not. Use :func:`os.path.abspath` semantics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>
    <span class="n">abspath</span> <span class="o">=</span> <span class="n">absolute</span>

<div class="viewcode-block" id="FilePath.changed"><a class="viewcode-back" href="../fs_filepath.html#fs.FilePath.changed">[docs]</a>    <span class="k">def</span> <span class="nf">changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dirname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">infix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new :class:`FilePath` with one or more parts changed. This is particularly</span>
<span class="sd">        convenient for, say, changing the extension of a file or producing a version on</span>
<span class="sd">        another path, eg::</span>

<span class="sd">            from winsys import fs, shell</span>

<span class="sd">            BACKUP_DRIVE = &quot;D:\\&quot;</span>
<span class="sd">            for f in fs.flat(shell.special_folder(&quot;personal&quot;), &quot;*.doc&quot;):</span>
<span class="sd">                f.copy(f.changed(root=BACKUP_DRIVE))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">and</span> <span class="p">(</span><span class="n">base</span> <span class="ow">or</span> <span class="n">ext</span> <span class="ow">or</span> <span class="n">infix</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">x_fs</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;FilePath.changed&quot;</span><span class="p">,</span> <span class="s2">&quot;You cannot change filename *and* base or ext or infix&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ext</span><span class="p">:</span> <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span>
        <span class="n">_filename</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_base</span><span class="p">,</span> <span class="n">_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">base</span> <span class="ow">or</span> <span class="n">ext</span><span class="p">):</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span> <span class="ow">or</span> <span class="n">_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">infix</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="n">infix</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">from_parts</span><span class="p">(</span><span class="n">root</span> <span class="ow">or</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dirname</span> <span class="ow">or</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">base</span> <span class="ow">or</span> <span class="n">_base</span><span class="p">,</span> <span class="n">ext</span> <span class="ow">or</span> <span class="n">_ext</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilePath.from_parts"><a class="viewcode-back" href="../fs_filepath.html#fs.FilePath.from_parts">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_parts</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recreate a filepath from its constituent parts. No real validation is done;</span>
<span class="sd">        it is assumed that the parameters are valid parts of a filepath.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">root</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">base</span><span class="o">+</span><span class="n">ext</span><span class="p">]))</span></div></div>

<span class="n">filepath</span> <span class="o">=</span> <span class="n">FilePath</span>

<div class="viewcode-block" id="Drive"><a class="viewcode-back" href="../fs_drive_vol.html#fs.Drive">[docs]</a><span class="k">class</span> <span class="nc">Drive</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">_WinSysObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps a drive letter, offering access to its :attr:`Drive.volume`</span>
<span class="sd">    and the ability to :meth:`mount` or :meth:`dismount` it on a particular</span>
<span class="sd">    volume.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drive</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">drive</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">seps</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">sep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetDriveTypeW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="Drive.as_string"><a class="viewcode-back" href="../fs_drive_vol.html#fs.Drive.as_string">[docs]</a>    <span class="k">def</span> <span class="nf">as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Drive </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>

    <span class="k">def</span> <span class="nf">_get_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :class:`fs.Dir` object corresponding to the</span>
<span class="sd">        root directory of this drive.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_root</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Any volume currently mounted on this drive root. NB A drive</span>
<span class="sd">        can be referred to without a volume mounted, eg to call its :meth:`mount`</span>
<span class="sd">        method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">x_no_such_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_volume</span><span class="p">)</span>

<div class="viewcode-block" id="Drive.mount"><a class="viewcode-back" href="../fs_drive_vol.html#fs.Drive.mount">[docs]</a>    <span class="k">def</span> <span class="nf">mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mount the specified volume in this drive.</span>

<span class="sd">        :param vol: anything accepted by :func:`volume`</span>
<span class="sd">        :returns: `self`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Drive.dismount"><a class="viewcode-back" href="../fs_drive_vol.html#fs.Drive.dismount">[docs]</a>    <span class="k">def</span> <span class="nf">dismount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dismount this drive from its volume</span>

<span class="sd">        :returns: `self`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">dismount</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="k">def</span> <span class="nf">dumped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;type (DRIVE_TYPE): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">DRIVE_TYPE</span><span class="o">.</span><span class="n">name_from_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;volume:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="n">mount_points</span> <span class="o">=</span> <span class="p">[(</span><span class="n">mount_point</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">mount_point</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mounts</span><span class="p">()</span> <span class="k">if</span> <span class="n">mount_point</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mount_points:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped_list</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mount_points</span><span class="p">),</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">level</span><span class="p">)</span></div>

<div class="viewcode-block" id="Volume"><a class="viewcode-back" href="../fs_drive_vol.html#fs.Volume">[docs]</a><span class="k">class</span> <span class="nc">Volume</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">_WinSysObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps a filesystem volume, giving access to useful</span>
<span class="sd">    information such as the filesystem and a list of drives</span>
<span class="sd">    mounted on it. Also offers the ability to mount or dismount.</span>

<span class="sd">    Attributes:</span>

<span class="sd">    * :attr:`label`</span>
<span class="sd">    * :attr:`serial_number`</span>
<span class="sd">    * :attr:`maximum_component_length`</span>
<span class="sd">    * :attr:`flags` - combination of :const:`VOLUME_FLAG`</span>
<span class="sd">    * :attr:`file_system_name`</span>
<span class="sd">    * :attr:`mounts`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">volume</span>

<div class="viewcode-block" id="Volume.as_string"><a class="viewcode-back" href="../fs_drive_vol.html#fs.Volume.as_string">[docs]</a>    <span class="k">def</span> <span class="nf">as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>

    <span class="k">def</span> <span class="nf">_get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">GetVolumeInformation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">x_not_ready</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The user-assigned label set by the DOS LABEL command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">label</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_serial_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A software serial number, not the hardware serial</span>
<span class="sd">        number assigned by the device manufacturer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">serial_number</span><span class="p">,</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">serial_number</span>
    <span class="n">serial_number</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_serial_number</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_maximum_component_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The maximum length any one component of the file system</span>
<span class="sd">        name can reach. For NTFS this is 255, meaning that any one</span>
<span class="sd">        segment of of the path can be no longer than 255 chars.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">maximum_component_length</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_maximum_component_length</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An attribute set corresponding to some combination of :const:`VOLUME_FLAG`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">constants</span><span class="o">.</span><span class="n">Attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()[</span><span class="mi">3</span><span class="p">],</span> <span class="n">VOLUME_FLAG</span><span class="p">)</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_flags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_file_system_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The name of the file system present on this volume, eg NTFS&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">file_system_name</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_file_system_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_mounts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An iterator of the :class:`Dir` objects which mount this volume. NB Windows</span>
<span class="sd">        restrictions mean that no more than one drive root directory can mount the same</span>
<span class="sd">        volume simultaneously. But it is possible for a volume to be mounted on, eg,</span>
<span class="sd">        e:\ and c:\mounts\e at the same time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetVolumePathNamesForVolumeName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">mounts</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_mounts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dumped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;volume: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mounted at:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mounts</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;label: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;serial_number: </span><span class="si">%08x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_number</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;maximum_component_length: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximum_component_length</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;flags (VOLUME_FLAG):</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;file_system_name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_system_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">level</span><span class="p">)</span>

<div class="viewcode-block" id="Volume.mount"><a class="viewcode-back" href="../fs_drive_vol.html#fs.Volume.mount">[docs]</a>    <span class="k">def</span> <span class="nf">mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mount this volume on a particular filepath</span>

<span class="sd">        :param filepath: anything accepted by :func:`dir`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">mount</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Volume.dismount"><a class="viewcode-back" href="../fs_drive_vol.html#fs.Volume.dismount">[docs]</a>    <span class="k">def</span> <span class="nf">dismount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dismount this volume from a particular filepath</span>

<span class="sd">        :param filepath: anything accepted by :func:`dir`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">dir</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">dismount</span><span class="p">()</span></div></div>

<span class="k">class</span> <span class="nc">Share</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">_WinSysObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps a drive share</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">servername</span><span class="p">,</span> <span class="n">sharename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servername</span> <span class="o">=</span><span class="p">(</span><span class="n">servername</span> <span class="ow">or</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sharename</span> <span class="o">=</span> <span class="n">sharename</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="si">%s</span><span class="s2">\</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">servername</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharename</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="n">win32net</span><span class="o">.</span><span class="n">NetShareGetInfo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">servername</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharename</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">x_no_such_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="n">__nonzero__</span> <span class="o">=</span> <span class="fm">__bool__</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">info</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="k">def</span> <span class="nf">_get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32net</span><span class="o">.</span><span class="n">NetShareGetInfo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">servername</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharename</span><span class="p">,</span> <span class="mi">502</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">))</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_security</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">security_</span><span class="o">.</span><span class="n">security</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;security_descriptor&#39;</span><span class="p">))</span>
    <span class="n">security</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_security</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dumped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_security</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;type: (</span><span class="si">%d</span><span class="s2">) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">STYPE</span><span class="o">.</span><span class="n">names_from_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;remark: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">remark</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;path: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_security</span><span class="p">:</span>
            <span class="n">security</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span>
            <span class="k">if</span> <span class="n">security</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">security</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">servername</span><span class="p">,</span> <span class="n">sharename</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">remark</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">,</span> <span class="n">security</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">):</span>
        <span class="n">remark</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">remark</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span> <span class="k">else</span> <span class="n">remark</span>
        <span class="n">security</span> <span class="o">=</span> <span class="n">security_</span><span class="o">.</span><span class="n">security</span><span class="p">(</span><span class="kc">None</span> <span class="k">if</span> <span class="n">security</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span> <span class="k">else</span> <span class="n">security</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">netname</span><span class="o">=</span><span class="n">sharename</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">remark</span><span class="o">=</span><span class="n">remark</span><span class="p">,</span>
            <span class="n">security</span><span class="o">=</span><span class="n">security</span><span class="o">.</span><span class="n">pyobject</span><span class="p">()</span><span class="o">.</span><span class="n">SECURITY_DESCRIPTOR</span> <span class="k">if</span> <span class="n">security</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32net</span><span class="o">.</span><span class="n">NetShareAdd</span><span class="p">,</span> <span class="n">servername</span><span class="p">,</span> <span class="mi">502</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">servername</span><span class="p">,</span> <span class="n">sharename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">servername</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">,</span> <span class="n">sharename</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">,</span> <span class="n">remark</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">,</span> <span class="n">security</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">servername</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span> <span class="ow">and</span> <span class="n">sharename</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">x_fs</span><span class="p">(</span><span class="s2">&quot;At least one of servername and sharename must be specified&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">servername</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">servername</span> <span class="k">if</span> <span class="n">servername</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span> <span class="k">else</span> <span class="n">servername</span><span class="p">,</span>
            <span class="n">sharename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharename</span> <span class="k">if</span> <span class="n">sharename</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span> <span class="k">else</span> <span class="n">sharename</span><span class="p">,</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span> <span class="k">else</span> <span class="n">path</span><span class="p">,</span>
            <span class="n">remark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remark</span> <span class="k">if</span> <span class="n">remark</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span> <span class="k">else</span> <span class="n">remark</span><span class="p">,</span>
            <span class="n">security</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span> <span class="k">if</span> <span class="n">security</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span> <span class="k">else</span> <span class="n">security</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32net</span><span class="o">.</span><span class="n">NetShareDel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">servername</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharename</span><span class="p">)</span>

<div class="viewcode-block" id="Entry"><a class="viewcode-back" href="../fs_entry.html#fs.Entry">[docs]</a><span class="k">class</span> <span class="nc">Entry</span><span class="p">(</span><span class="n">FilePath</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">_WinSysObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heart of the fs module. This is a subtype of :class:`FilePath` and</span>
<span class="sd">    therefore of the base unicode type and is the parent of the</span>
<span class="sd">    :class:`Dir` and :class:`File` classes and contains all the</span>
<span class="sd">    functionality common to both. It is rarely instantiated itself,</span>
<span class="sd">    altho&#39; it&#39;s possible to do so.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    * :attr:`readable`</span>
<span class="sd">    * :attr:`filepath`</span>
<span class="sd">    * :attr:`created_at`</span>
<span class="sd">    * :attr:`accessed_at`</span>
<span class="sd">    * :attr:`written_at`</span>
<span class="sd">    * :attr:`uncompressed_size`</span>
<span class="sd">    * :attr:`size`</span>
<span class="sd">    * :attr:`attributes`</span>
<span class="sd">    * :attr:`id`</span>
<span class="sd">    * :attr:`n_links`</span>
<span class="sd">    * :attr:`attributes - an :class:`constants.Attributes` object representing combinations of :const:`FILE_ATTRIBUTE`</span>

<span class="sd">    Common functionality:</span>

<span class="sd">    * Entries compare (eq, lt, etc.) according to their full case-insensitive filepath.</span>
<span class="sd">        To do a content-wise comparison, use :meth:`equal_contents`.</span>
<span class="sd">    * Entries are True according to their existence on a filesystem</span>
<span class="sd">    * The str representation is the filepath utf8-encoded; unicode is the filepath itself</span>
<span class="sd">    * Adding one path to another will use os.path.join semantics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">_file_info</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">):</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">FilePath</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">_normpath</span> <span class="o">=</span> <span class="n">normalised</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># An Entry can be initialised from a Win32 FIND_FILES object, in which</span>
        <span class="c1"># case cache the information available for speed.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">_file_info</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_created_at</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_accessed_at</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_written_at</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_reparse_tag</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Attributes</span><span class="p">(</span><span class="n">_file_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">FILE_ATTRIBUTE</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_created_at</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">from_pytime</span><span class="p">(</span><span class="n">_file_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_accessed_at</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">from_pytime</span><span class="p">(</span><span class="n">_file_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_written_at</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">from_pytime</span><span class="p">(</span><span class="n">_file_info</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_longword</span><span class="p">(</span><span class="n">_file_info</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">_file_info</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">_reparse_tag</span> <span class="o">=</span> <span class="n">_file_info</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fp</span>

<div class="viewcode-block" id="Entry.as_string"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.as_string">[docs]</a>    <span class="k">def</span> <span class="nf">as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Entry.dumped"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.dumped">[docs]</a>    <span class="k">def</span> <span class="nf">dumped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_security</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;readable: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">readable</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readable</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;id: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;n_links: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_links</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;created_at: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;accessed_at: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">accessed_at</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;written_at: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">written_at</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;uncompressed_size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncompressed_size</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;size: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Attributes:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
            <span class="n">is_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">directory</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">is_directory</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">is_directory</span><span class="p">:</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mounted_by</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">vol</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Mount point for:&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">show_security</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">win32file</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
                <span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">errctx</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">)</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">args</span>
                <span class="k">if</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_ACCESS_DENIED</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Security:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">is_directory</span><span class="p">:</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mounted_by</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">vol</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Mount point for:&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vol</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">level</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entry</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entry</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__radd__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine whether the file exists (at least from</span>
<span class="sd">        the POV of the current user) on the filesystem so that</span>
<span class="sd">        it can be checked with if fs.entry (&quot;...&quot;):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetFileAttributesW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="fm">__bool__</span> <span class="o">=</span> <span class="n">__nonzero__</span>

<div class="viewcode-block" id="Entry.factory"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">entry</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># Check whether the user has at least enough</span>
        <span class="c1"># permissions to open the file for reading.</span>
        <span class="c1">#</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="n">readable</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_readable</span><span class="p">)</span>

<div class="viewcode-block" id="Entry.get_created_at"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.get_created_at">[docs]</a>    <span class="k">def</span> <span class="nf">get_created_at</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get and store the latest creation time from the filesystem. Note that this forces a</span>
<span class="sd">        re-read of the metadata.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_created_at</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">from_pytime</span><span class="p">(</span><span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetFileAttributesExW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_created_at</span></div>
    <span class="k">def</span> <span class="nf">_get_created_at</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the creation time from the original file read or the latest from</span>
<span class="sd">        the filesystem if none was stored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_created_at</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_created_at</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_created_at</span>
    <span class="k">def</span> <span class="nf">_set_created_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">created_at</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Handle</span><span class="p">(</span><span class="n">handle</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">normapth</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">created_at</span> <span class="o">=</span> <span class="n">pywintypes</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">created_at</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">SetFileTime</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">created_at</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_created_at</span><span class="p">,</span> <span class="n">_set_created_at</span><span class="p">)</span>

<div class="viewcode-block" id="Entry.get_accessed_at"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.get_accessed_at">[docs]</a>    <span class="k">def</span> <span class="nf">get_accessed_at</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get and store the latest access time from the filesystem. Note that this</span>
<span class="sd">        forces a re-read of the metadata&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accessed_at</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">from_pytime</span><span class="p">(</span><span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetFileAttributesExW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accessed_at</span></div>
    <span class="k">def</span> <span class="nf">_get_accessed_at</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the access time from the original file read or the latest from</span>
<span class="sd">        the filesystem if none was stored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accessed_at</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_accessed_at</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_accessed_at</span>
    <span class="k">def</span> <span class="nf">_set_accessed_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accessed_at</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Handle</span><span class="p">(</span><span class="n">handle</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">accessed_at</span> <span class="o">=</span> <span class="n">pywintypes</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">accessed_at</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">SetFileTime</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">accessed_at</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">accessed_at</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_accessed_at</span><span class="p">,</span> <span class="n">_set_accessed_at</span><span class="p">)</span>

<div class="viewcode-block" id="Entry.get_written_at"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.get_written_at">[docs]</a>    <span class="k">def</span> <span class="nf">get_written_at</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get and store the latest modification time from the filesystem. Note that this</span>
<span class="sd">        forces a re-read of the metadata&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_written_at</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">from_pytime</span><span class="p">(</span><span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetFileAttributesExW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_written_at</span></div>
    <span class="k">def</span> <span class="nf">_get_written_at</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get and store the modification time from the original file read or the latest from</span>
<span class="sd">        the filesystem if none was stored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_written_at</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_written_at</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_written_at</span>
    <span class="k">def</span> <span class="nf">_set_written_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">written_at</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Handle</span><span class="p">(</span><span class="n">handle</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">written_at</span> <span class="o">=</span> <span class="n">pywintypes</span><span class="o">.</span><span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">written_at</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()))</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">SetFileTime</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">written_at</span><span class="p">)</span>
    <span class="n">written_at</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_written_at</span><span class="p">,</span> <span class="n">_set_written_at</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_uncompressed_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the size of the file data, ignoring any filesystem</span>
<span class="sd">        compression which may have been applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Handle</span><span class="p">(</span><span class="n">handle</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetFileSize</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
    <span class="n">uncompressed_size</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_uncompressed_size</span><span class="p">)</span>

<div class="viewcode-block" id="Entry.get_size"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.get_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get and store the latest (possibly compressed) size from the filesystem. Note that this</span>
<span class="sd">        forces a re-read of the metadata&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">_kernel32</span><span class="o">.</span><span class="n">GetCompressedFileSize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span></div>
    <span class="k">def</span> <span class="nf">_get_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get and store the (possibly compressed) size from the original file read or the latest from</span>
<span class="sd">        the filesystem if none was stored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_size</span><span class="p">)</span>

<div class="viewcode-block" id="Entry.get_attributes"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.get_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get and store the latest file attributes from the filesystem. Note that this</span>
<span class="sd">        forces a re-read of the metadata&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Attributes</span><span class="p">(</span><span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetFileAttributesExW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">FILE_ATTRIBUTE</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span></div>
    <span class="k">def</span> <span class="nf">_get_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get and store the file attributes from the original file read or the latest from</span>
<span class="sd">        the filesystem if none was stored.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attributes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_attributes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an id for this file which can be used to compare it to another while</span>
<span class="sd">        both files are open to determine if both are the same physical file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">hFile</span><span class="p">:</span>
            <span class="n">file_information</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetFileInformationByHandle</span><span class="p">,</span> <span class="n">hFile</span><span class="p">)</span>
            <span class="n">volume_serial_number</span> <span class="o">=</span> <span class="n">file_information</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">index_lo</span><span class="p">,</span> <span class="n">index_hi</span> <span class="o">=</span> <span class="n">file_information</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">volume_serial_number</span> <span class="o">+</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">_longword</span><span class="p">(</span><span class="n">index_hi</span><span class="p">,</span> <span class="n">index_lo</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_n_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine how many links point to this file. &gt;1 indicates that</span>
<span class="sd">        the file is hardlinked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Handle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">as</span> <span class="n">hFile</span><span class="p">:</span>
            <span class="n">file_information</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetFileInformationByHandle</span><span class="p">,</span> <span class="n">hFile</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">file_information</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">n_links</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_n_links</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_file_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">FILE_ATTRIBUTE</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">SetFileAttributesW</span><span class="p">,</span> <span class="n">normalised</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">flags</span> <span class="o">|</span> <span class="n">attr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">SetFileAttributesW</span><span class="p">,</span> <span class="n">normalised</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">attr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the archive bit set on the file?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">archive</span>
    <span class="k">def</span> <span class="nf">_set_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_file_attribute</span><span class="p">(</span><span class="s2">&quot;archive&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_archive</span><span class="p">,</span> <span class="n">_set_archive</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_compressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file compressed?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">compressed</span>
    <span class="n">compressed</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_compressed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file a directory?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">directory</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_directory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_encrypted</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file encrypted?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">encrypted</span>
    <span class="n">encrypted</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_encrypted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file hidden?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">hidden</span>
    <span class="k">def</span> <span class="nf">_set_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_file_attribute</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">hidden</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_hidden</span><span class="p">,</span> <span class="n">_set_hidden</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file normal?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">normal</span>
    <span class="k">def</span> <span class="nf">_set_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">SetFileAttributesW</span><span class="p">,</span> <span class="n">normalised</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">FILE_ATTRIBUTE</span><span class="o">.</span><span class="n">NORMAL</span><span class="p">)</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_normal</span><span class="p">,</span> <span class="n">_set_normal</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_not_content_indexed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Should the file&#39;s content not be indexed?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">not_content_indexed</span>
    <span class="k">def</span> <span class="nf">_set_not_content_indexed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_file_attribute</span><span class="p">(</span><span class="s2">&quot;not_content_indexed&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">not_content_indexed</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_not_content_indexed</span><span class="p">,</span> <span class="n">_set_not_content_indexed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file offline?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">offline</span>
    <span class="k">def</span> <span class="nf">_set_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_file_attribute</span><span class="p">(</span><span class="s2">&quot;offline&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">offline</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_offline</span><span class="p">,</span> <span class="n">_set_offline</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file readonly?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">readonly</span>
    <span class="k">def</span> <span class="nf">_set_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_file_attribute</span><span class="p">(</span><span class="s2">&quot;readonly&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">readonly</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_readonly</span><span class="p">,</span> <span class="n">_set_readonly</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_reparse_point</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file a reparse point?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">reparse_point</span>
    <span class="n">reparse_point</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_reparse_point</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_sparse_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file sparse?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">sparse_file</span>
    <span class="n">sparse_file</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_sparse_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file a system file?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">system</span>
    <span class="k">def</span> <span class="nf">_set_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_file_attribute</span><span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">system</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_system</span><span class="p">,</span> <span class="n">_set_system</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_temporary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file a temporary file?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">temporary</span>
    <span class="k">def</span> <span class="nf">_set_temporary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_file_attribute</span><span class="p">(</span><span class="s2">&quot;temporary&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">temporary</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_temporary</span><span class="p">,</span> <span class="n">_set_temporary</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the file a virtual file?&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">virtual</span>
    <span class="n">virtual</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_virtual</span><span class="p">)</span>

<div class="viewcode-block" id="Entry.like"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.like">[docs]</a>    <span class="k">def</span> <span class="nf">like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if this filename&#39;s name (not the path) matches</span>
<span class="sd">        `pattern` according to `fnmatch`, eg::</span>

<span class="sd">            from winsys import fs</span>
<span class="sd">            for f in fs.files ():</span>
<span class="sd">                if f.directory and f.like(&quot;test_*&quot;):</span>
<span class="sd">                    print f</span>

<span class="sd">        :param pattern: an `fnmatch` pattern</span>
<span class="sd">        :returns: True if this file matches `pattern`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span></div>

<div class="viewcode-block" id="Entry.ancestors"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.ancestors">[docs]</a>    <span class="k">def</span> <span class="nf">ancestors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over this entry&#39;s ancestors, yielding the :class:`Dir` object</span>
<span class="sd">        corresponding to each one.</span>

<span class="sd">        :returns: yield a :class:`Dir` object for each ancestor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
            <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">ancestors</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">ancestor</span></div>

<div class="viewcode-block" id="Entry.handle"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.handle">[docs]</a>    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">handles</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">,</span> <span class="n">exclusive</span><span class="o">=</span><span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">))</span></div>

<div class="viewcode-block" id="Entry.security"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.security">[docs]</a>    <span class="k">def</span> <span class="nf">security</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">security_</span><span class="o">.</span><span class="n">Security</span><span class="o">.</span><span class="n">DEFAULT_OPTIONS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :class:`security_.Security` object corresponding to this</span>
<span class="sd">        entry&#39;s security attributes. Note that the returning object is a context</span>
<span class="sd">        manager so a common pattern is::</span>

<span class="sd">            #</span>
<span class="sd">            # Find all private key files and ensure that only</span>
<span class="sd">            # the owner has any access.</span>
<span class="sd">            #</span>
<span class="sd">            from winsys import fs</span>
<span class="sd">            for f in fs.flat(&quot;*.ppk&quot;):</span>
<span class="sd">                with f.security() as s:</span>
<span class="sd">                    s.break_inheritance()</span>
<span class="sd">                    s.dacl = [(s.owner, &quot;F&quot;, &quot;ALLOW&quot;)]</span>

<span class="sd">        :param options: cf :func:`security_.security`</span>
<span class="sd">        :returns: a :class:`security_.Security` object which may be used as a context manager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">security_</span><span class="o">.</span><span class="n">security</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span></div>

<div class="viewcode-block" id="Entry.compress"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.compress">[docs]</a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compress this entry; if it is a file, it will be compressed, if it</span>
<span class="sd">        is a directory it will be marked so that any new files added to it will</span>
<span class="sd">        be compressed automatically.</span>

<span class="sd">        :returns: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">hFile</span><span class="p">:</span>
            <span class="n">compression_type</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">COMPRESSION_FORMAT</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">)</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">DeviceIoControl</span><span class="p">,</span> <span class="n">hFile</span><span class="p">,</span> <span class="n">FSCTL</span><span class="o">.</span><span class="n">SET_COMPRESSION</span><span class="p">,</span> <span class="n">compression_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Entry.uncompress"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.uncompress">[docs]</a>    <span class="k">def</span> <span class="nf">uncompress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uncompress this entry; if it is a file, it will be uncompressed, if it</span>
<span class="sd">        is a directory it will be marked so that any new files added to it will</span>
<span class="sd">        not be compressed automatically.</span>

<span class="sd">        :returns: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">Handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">hFile</span><span class="p">:</span>
            <span class="n">compression_type</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">COMPRESSION_FORMAT</span><span class="o">.</span><span class="n">NONE</span><span class="p">)</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">DeviceIoControl</span><span class="p">,</span> <span class="n">hFile</span><span class="p">,</span> <span class="n">FSCTL</span><span class="o">.</span><span class="n">SET_COMPRESSION</span><span class="p">,</span> <span class="n">compression_type</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Entry.encrypt"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.encrypt">[docs]</a>    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FIXME: Need to work out how to create certificates for this</span>

<span class="sd">        :returns: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">EncryptFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Entry.unencrypt"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.unencrypt">[docs]</a>    <span class="k">def</span> <span class="nf">unencrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FIXME: Need to work out how to create certificates for this</span>

<span class="sd">        :returns: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">DecryptFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Entry.encryption_users"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.encryption_users">[docs]</a>    <span class="k">def</span> <span class="nf">encryption_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;FIXME: Need to work out how to create certificates for this</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">security_</span><span class="o">.</span><span class="n">principal</span><span class="p">(</span><span class="n">sid</span><span class="p">),</span> <span class="n">hashblob</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">hashblob</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
                <span class="ow">in</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">QueryUsersOnEncryptedFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Entry.move"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move this entry to the file/directory represented by other.</span>
<span class="sd">        If other is a directory, self</span>

<span class="sd">        :param other: anything accepted by :func:`entry`</span>
<span class="sd">        :param callback: a function which will receive a total size &amp; total transferred</span>
<span class="sd">        :param callback_data: passed as extra data to callback</span>
<span class="sd">        :param clobber: whether to overwrite the other file if it exists</span>
<span class="sd">        :returns: a :class:`File` object corresponding to the target file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other_file</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># If the target is already a directory, the result of the move will</span>
        <span class="c1"># be a file or a directory inside that directory. Otherwise the</span>
        <span class="c1"># result will be a new file or directory inside the target&#39;s</span>
        <span class="c1"># parent.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">other_file</span> <span class="ow">and</span> <span class="n">other_file</span><span class="o">.</span><span class="n">directory</span><span class="p">:</span>
            <span class="n">target_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">other_file</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">other_file</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">MOVEFILE</span><span class="o">.</span><span class="n">WRITE_THROUGH</span>
        <span class="k">if</span> <span class="n">clobber</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">MOVEFILE</span><span class="o">.</span><span class="n">REPLACE_EXISTING</span>
        <span class="n">wrapped</span><span class="p">(</span>
            <span class="n">win32file</span><span class="o">.</span><span class="n">MoveFileWithProgress</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">,</span>
            <span class="n">normalised</span><span class="p">(</span><span class="n">target_filepath</span><span class="p">),</span>
            <span class="n">progress_wrapper</span><span class="p">(</span><span class="n">callback</span><span class="p">),</span>
            <span class="n">callback_data</span><span class="p">,</span>
            <span class="n">flags</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">entry</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">target_filepath</span><span class="p">))</span></div>
    <span class="n">rename</span> <span class="o">=</span> <span class="n">move</span>

<div class="viewcode-block" id="Entry.take_control"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.take_control">[docs]</a>    <span class="k">def</span> <span class="nf">take_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">principal</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Give the logged-on user full control to a file. This may</span>
<span class="sd">        need to be preceded by a call to :func:`take_ownership` so that the</span>
<span class="sd">        user gains WRITE_DAC permissions.</span>

<span class="sd">        :param principal: anything accepted by :func:`principal` [logged-on user]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">principal</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="n">principal</span> <span class="o">=</span> <span class="n">security_</span><span class="o">.</span><span class="n">me</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Specify only DACL when reading as we may have no more rights</span>
        <span class="c1"># than that, and we don&#39;t need any more.</span>
        <span class="c1">#</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">dacl</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">principal</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;ALLOW&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Entry.take_ownership"><a class="viewcode-back" href="../fs_entry.html#fs.Entry.take_ownership">[docs]</a>    <span class="k">def</span> <span class="nf">take_ownership</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">principal</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the new owner of the file to be the logged-on user.</span>
<span class="sd">        This is no more than a slight shortcut to the equivalent</span>
<span class="sd">        security operations.</span>

<span class="sd">        If you specify a principal (other than the logged-in user,</span>
<span class="sd">        the default) you may need to have enabled SE_RESTORE privilege.</span>
<span class="sd">        Even the logged-in user may need to have enabled SE_TAKE_OWNERSHIP</span>
<span class="sd">        if that user has not been granted the appropriate security by</span>
<span class="sd">        the ACL::</span>

<span class="sd">            from winsys import fs, security</span>

<span class="sd">            f = fs.file(&quot;c:/temp/temp.txt&quot;)</span>
<span class="sd">            assert f</span>
<span class="sd">            with security_.change_privileges([&quot;take_ownership&quot;]):</span>
<span class="sd">                f.take_ownership()</span>
<span class="sd">                f.take_control()</span>

<span class="sd">        :param principal: anything accepted by :func:`principal` [logged-on user]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">principal</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="n">principal</span> <span class="o">=</span> <span class="n">security_</span><span class="o">.</span><span class="n">me</span><span class="p">()</span>
        <span class="c1">#</span>
        <span class="c1"># Specify no options when reading as we may have no rights</span>
        <span class="c1"># whatsoever on the security descriptor and be relying on</span>
        <span class="c1"># the take_ownership privilege.</span>
        <span class="c1">#</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">security</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">principal</span></div></div>

<div class="viewcode-block" id="File"><a class="viewcode-back" href="../fs_file.html#fs.File">[docs]</a><span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="n">Entry</span><span class="p">):</span>

    <span class="c1">##</span>
    <span class="c1">## 3 ways in which 2 files can be equal:</span>
    <span class="c1">##     Their filepaths are equal</span>
    <span class="c1">##     Their ids (inodes) are equal</span>
    <span class="c1">##     Their contents are equal</span>
    <span class="c1">##</span>
<div class="viewcode-block" id="File.open_"><a class="viewcode-back" href="../fs_file.html#fs.File.open_">[docs]</a>    <span class="k">def</span> <span class="nf">open_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;EXPERIMENTAL: Use the `codecs.open` function to open this file as a Python file</span>
<span class="sd">        object. Positional and keyword arguments are passed straight through to</span>
<span class="sd">        the codecs function.</span>

<span class="sd">        :param mode: any of the usual Python modes</span>
<span class="sd">        :param attributes: anything accepted by :const:`FILE_ATTRIBUTE`</span>
<span class="sd">        :param sec: anything accepted by :func:`Security.security`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">mode</span> <span class="k">else</span> <span class="s2">&quot;r&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hFile</span> <span class="o">=</span> <span class="n">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sec</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s2">&quot;t&quot;</span> <span class="ow">in</span> <span class="n">mode</span> <span class="ow">or</span> <span class="s2">&quot;b&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_TEXT</span>
        <span class="k">if</span> <span class="s2">&quot;r&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span>
        <span class="k">elif</span> <span class="s2">&quot;a&quot;</span> <span class="ow">in</span> <span class="n">mode</span> <span class="ow">or</span> <span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">|=</span> <span class="n">os</span><span class="o">.</span><span class="n">O_APPEND</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">open_osfhandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hFile</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.delete"><a class="viewcode-back" href="../fs_file.html#fs.File.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete this file</span>

<span class="sd">        :returns: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">DeleteFileW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="File.copy"><a class="viewcode-back" href="../fs_file.html#fs.File.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy this file to another file or directory. If other is</span>
<span class="sd">        a directory, this file is copied into it, otherwise this file</span>
<span class="sd">        is copied over it.</span>

<span class="sd">        :param other: anything accepted by :func:`entry`</span>
<span class="sd">        :param callback: function receiving total size, total so far, callback_data</span>
<span class="sd">        :param callback_data: passed to callback</span>
<span class="sd">        :returns: :class:`File` object representing other</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other_file</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other_file</span> <span class="ow">and</span> <span class="n">other_file</span><span class="o">.</span><span class="n">directory</span><span class="p">:</span>
            <span class="n">target_filepath</span> <span class="o">=</span> <span class="n">other_file</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_filepath</span> <span class="o">=</span> <span class="n">other_file</span>
        <span class="n">wrapped</span><span class="p">(</span>
            <span class="n">win32file</span><span class="o">.</span><span class="n">CopyFileEx</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">,</span>
            <span class="n">normalised</span><span class="p">(</span><span class="n">target_filepath</span><span class="p">),</span>
            <span class="n">progress_wrapper</span><span class="p">(</span><span class="n">callback</span><span class="p">),</span>
            <span class="n">callback_data</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">file</span><span class="p">(</span><span class="n">target_filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.equal_contents"><a class="viewcode-back" href="../fs_file.html#fs.File.equal_contents">[docs]</a>    <span class="k">def</span> <span class="nf">equal_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare only the contents of the two files, ignoring</span>
<span class="sd">        everything else. Note that filecmp.cmp fails early.</span>

<span class="sd">        :param other: anything accepted by :func:`file`</span>
<span class="sd">        :returns: True if the files are equal in contents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.equals"><a class="viewcode-back" href="../fs_file.html#fs.File.equals">[docs]</a>    <span class="k">def</span> <span class="nf">equals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">compare_contents</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this file equal in size, dates and attributes to another.</span>
<span class="sd">        if `compare_contents` is True, use filecmp to compare the contents</span>
<span class="sd">        of the files. Note that filecmp.cmp fails early.</span>

<span class="sd">        :param other: anything accepted by :func:`file`</span>
<span class="sd">        :compare_contents: True to compare contents, False otherwise</span>
<span class="sd">        :returns: True if the files are equal in size, modification date, attributes and contents</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">written_at</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">written_at</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">compare_contents</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="File.hard_link_to"><a class="viewcode-back" href="../fs_file.html#fs.File.hard_link_to">[docs]</a>    <span class="k">def</span> <span class="nf">hard_link_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create `other` as a hard link to this file.</span>

<span class="sd">        :param other: anything accepted by :func:`file`</span>
<span class="sd">        :returns: :class:`File` object corresponding to `other`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">wrapped</span><span class="p">(</span>
            <span class="n">win32file</span><span class="o">.</span><span class="n">CreateHardLink</span><span class="p">,</span>
            <span class="n">other</span><span class="o">.</span><span class="n">_normpath</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">other</span></div>

<div class="viewcode-block" id="File.hard_link_from"><a class="viewcode-back" href="../fs_file.html#fs.File.hard_link_from">[docs]</a>    <span class="k">def</span> <span class="nf">hard_link_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create this file as a hard link from other</span>

<span class="sd">        :param other: anything accepted by :func:`file`</span>
<span class="sd">        :returns: this :class:`File` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">wrapped</span><span class="p">(</span>
            <span class="n">win32file</span><span class="o">.</span><span class="n">CreateHardLink</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">,</span>
            <span class="n">other</span><span class="o">.</span><span class="n">_normpath</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="File.create"><a class="viewcode-back" href="../fs_file.html#fs.File.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">security</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create this file optionally with specific security_. If the</span>
<span class="sd">        file already exists it will not be overwritten.</span>

<span class="sd">        :param security: a :class:`security_.Security` object</span>
<span class="sd">        :returns: this object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapped</span><span class="p">(</span>
            <span class="n">win32file</span><span class="o">.</span><span class="n">CreateFile</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">,</span>
            <span class="n">FILE_ACCESS</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="kc">None</span> <span class="k">if</span> <span class="n">security</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">security_</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(),</span>
            <span class="n">FILE_CREATION</span><span class="o">.</span><span class="n">OPEN_ALWAYS</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="kc">None</span>
        <span class="p">)</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="File.zip"><a class="viewcode-back" href="../fs_file.html#fs.File.zip">[docs]</a>    <span class="k">def</span> <span class="nf">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_filename</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">,</span> <span class="n">allow_zip64</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Zip the file up into a zipfile. By default, the zipfile will have the</span>
<span class="sd">        name of the file with &quot;.zip&quot; appended and will be a sibling of the file.</span>
<span class="sd">        Also by default a new zipfile will be created, overwriting any existing one, and</span>
<span class="sd">        standard compression will be used. The filename will be stored without any directory</span>
<span class="sd">        information.</span>

<span class="sd">        A different zipfile can be specific as the zip_filename parameter, and this</span>
<span class="sd">        can be appended to (if it exists) by specifying &quot;a&quot; as the mode param.</span>

<span class="sd">        :param zip_filename: The name of the resulting zipfile [this file with the extension changed to .zip]</span>
<span class="sd">        :param mode: mode (usually &quot;w&quot;) to pass to the zipfile constructor</span>
<span class="sd">        :param compression: compression level (usually DEFLATED)</span>
<span class="sd">        :param allow_zip64: passed to the zipfile constructor to allow &gt; 2Gb files</span>
<span class="sd">        :returns: a :class:`File` object corresponding to the zipfile created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zip_filename</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="n">zip_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">(</span><span class="n">ext</span><span class="o">=</span><span class="s2">&quot;.zip&quot;</span><span class="p">)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span> <span class="n">allow_zip64</span><span class="p">)</span>
        <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">z</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">file</span><span class="p">(</span><span class="n">zip_filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.bytes"><a class="viewcode-back" href="../fs_file.html#fs.File.bytes">[docs]</a>    <span class="k">def</span> <span class="nf">bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the contents of the file as a bytes object (str in 2.x)</span>

<span class="sd">        :returns: a bytes/str object corresponding to the contents of the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>

<div class="viewcode-block" id="File.text"><a class="viewcode-back" href="../fs_file.html#fs.File.text">[docs]</a>    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the contents of the file as a text object (unicode in 2.x)</span>

<span class="sd">        :param encoding: valid encoding to pass to codecs.open</span>
<span class="sd">        :returns: a text/unicode object corresponding to the contents of the file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>

    <span class="n">touch</span> <span class="o">=</span> <span class="n">create</span></div>

<div class="viewcode-block" id="Dir"><a class="viewcode-back" href="../fs_dir.html#fs.Dir">[docs]</a><span class="k">class</span> <span class="nc">Dir</span><span class="p">(</span><span class="n">Entry</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="c1"># Ensure that a directory always ends in a backslash</span>
        <span class="c1">#</span>
        <span class="k">return</span> <span class="n">Entry</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">filepath</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">seps</span><span class="p">)</span> <span class="o">+</span> <span class="n">sep</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Dir.is_empty"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.is_empty">[docs]</a>    <span class="k">def</span> <span class="nf">is_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Returns True if this directory is empty, False otherwise. Will fail</span>
<span class="sd">        if the directory does not yet exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Dir.compress"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.compress">[docs]</a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apply_to_contents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flag this directory so that any new files are automatically</span>
<span class="sd">        compressed. If apply_to_contents is True, iterate over all subdirectories</span>
<span class="sd">        and their files, compressing likewise.</span>

<span class="sd">        :param apply_to_contents: whether to compress all existing subdirectories</span>
<span class="sd">                                                            and their files</span>
<span class="sd">        :param callback: called for each subdirectory / file compressed</span>
<span class="sd">        :returns: this directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Entry</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">apply_to_contents</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
                <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
                    <span class="nb">dir</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">compress</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Dir.uncompress"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.uncompress">[docs]</a>    <span class="k">def</span> <span class="nf">uncompress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apply_to_contents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flag this directory so that any new files are automatically</span>
<span class="sd">        not compressed. If apply_to_contents is True, iterate over all</span>
<span class="sd">        subdirectories and their files, uncompressing likewise.</span>

<span class="sd">        :param apply_to_contents: whether to uncompress all existing subdirectories</span>
<span class="sd">                                                            and their files</span>
<span class="sd">        :param callback: called for each subdirectory / file uncompressed</span>
<span class="sd">        :returns: this directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Entry</span><span class="o">.</span><span class="n">uncompress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">apply_to_contents</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
                <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
                    <span class="nb">dir</span><span class="o">.</span><span class="n">uncompress</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span> <span class="n">callback</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">uncompress</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Dir.encrypt"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.encrypt">[docs]</a>    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apply_to_contents</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">Entry</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">apply_to_contents</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
                <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                    <span class="nb">dir</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">encrypt</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Dir.unencrypt"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.unencrypt">[docs]</a>    <span class="k">def</span> <span class="nf">unencrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apply_to_contents</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">Entry</span><span class="o">.</span><span class="n">unencrypt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">apply_to_contents</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
                <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                    <span class="nb">dir</span><span class="o">.</span><span class="n">unencrypt</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">file</span><span class="o">.</span><span class="n">unencrypt</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Dir.disable_encryption"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.disable_encryption">[docs]</a>    <span class="k">def</span> <span class="nf">disable_encryption</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32security</span><span class="o">.</span><span class="n">EncryptionDisable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Dir.enable_encryption"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.enable_encryption">[docs]</a>    <span class="k">def</span> <span class="nf">enable_encryption</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32security</span><span class="o">.</span><span class="n">EncryptionDisable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Dir.create"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">security_descriptor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create this directory, optionally specifying a security descriptor.</span>
<span class="sd">        If the directory already exists, silently succeed.</span>
<span class="sd">        All intervening directories are automatically created if they do not</span>
<span class="sd">        already exist. If any exists but is a file rather than a directory,</span>
<span class="sd">        an exception is raised.</span>

<span class="sd">        :param security_descriptor: anything accepted by :func:`security_.security`</span>
<span class="sd">        :returns: a :class:`Dir` representing the newly-created directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">security_descriptor</span> <span class="o">=</span> <span class="n">security_</span><span class="o">.</span><span class="n">security</span><span class="p">(</span><span class="n">security_descriptor</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parts</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">pieces</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">piece</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pieces</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">normalised</span><span class="p">(</span><span class="n">root</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pieces</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">directory</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">x_fs</span><span class="p">(</span><span class="n">errctx</span><span class="o">=</span><span class="s2">&quot;Dir.create&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> exists and is not a directory&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wrapped</span><span class="p">(</span>
                    <span class="n">win32file</span><span class="o">.</span><span class="n">CreateDirectory</span><span class="p">,</span>
                    <span class="n">path</span><span class="p">,</span>
                    <span class="n">security_descriptor</span><span class="o">.</span><span class="n">pyobject</span><span class="p">()</span> <span class="k">if</span> <span class="n">security_descriptor</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dir.mkdir"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.mkdir">[docs]</a>    <span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">security_descriptor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Create :dirname: as a subdirectory of this directory, specifying a</span>
<span class="sd">        security descriptor. This is implemented in terms of :meth:`create`</span>
<span class="sd">        by concatenating this directory and dirname and calling .create on the</span>
<span class="sd">        resulting :class:`Dir` object.</span>

<span class="sd">        :param dirname: a relative path</span>
<span class="sd">        :param security_descriptor: anything accepted by :func:`security_.security`</span>
<span class="sd">        :returns: a :class:`Dir` representing the newly-created directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">security_descriptor</span><span class="o">=</span><span class="n">security_descriptor</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dir.entries"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.entries">[docs]</a>    <span class="k">def</span> <span class="nf">entries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Iterate over all entries -- files &amp; directories -- in this directory.</span>
<span class="sd">        Implemented via :func:`files`</span>

<span class="sd">        :param pattern: a \|-separated list of wildcards to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">files</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span> <span class="o">+</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    <span class="fm">__iter__</span> <span class="o">=</span> <span class="n">entries</span>

<div class="viewcode-block" id="Dir.file"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.file">[docs]</a>    <span class="k">def</span> <span class="nf">file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :class:`File` object representing a file called name inside</span>
<span class="sd">        this directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">file</span><span class="p">(</span><span class="bp">self</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dir.dir"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.dir">[docs]</a>    <span class="k">def</span> <span class="nf">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :class:`Dir` object representing a Directory called name inside</span>
<span class="sd">        this directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dir.files"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.files">[docs]</a>    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over all files in this directory which match pattern, yielding</span>
<span class="sd">        a :class:`File` object for each one. Implemented via :meth:`Dir.entries`.</span>

<span class="sd">        :param pattern: a \|-separated list of wildcards to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">File</span><span class="p">))</span></div>

<div class="viewcode-block" id="Dir.dirs"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.dirs">[docs]</a>    <span class="k">def</span> <span class="nf">dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over all directories in this directory which match pattern, yielding</span>
<span class="sd">        a :class:`Dir` object for each one. Implemented via :meth:`Dir.entries`.</span>

<span class="sd">        :param pattern: a \|-separated list of wildcards to match</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Dir</span><span class="p">))</span></div>

<div class="viewcode-block" id="Dir.walk"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.walk">[docs]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depthfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mimic os.walk, iterating over each directory and the files within</span>
<span class="sd">        in. Each iteration yields:</span>

<span class="sd">            :class:`Dir`, (generator for :class:`Dir` objects), (generator for :class:`File` objects)</span>

<span class="sd">        :param depthfirst: Whether to use breadth-first (the default) or depth-first traversal</span>
<span class="sd">        :param error_handler: a callable which is passed sys.exc_info and returns True if the iteration is to continue, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">top</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">dirs</span><span class="p">,</span> <span class="n">nondirs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">(</span><span class="n">error_handler</span><span class="o">=</span><span class="n">error_handler</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Dir</span><span class="p">):</span>
                <span class="n">dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nondirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">depthfirst</span><span class="p">:</span> <span class="k">yield</span> <span class="n">top</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">nondirs</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">depthfirst</span><span class="o">=</span><span class="n">depthfirst</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="n">error_handler</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">depthfirst</span><span class="p">:</span> <span class="k">yield</span> <span class="n">top</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">nondirs</span></div>

<div class="viewcode-block" id="Dir.flat"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.flat">[docs]</a>    <span class="k">def</span> <span class="nf">flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">includedirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">depthfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate over this directory and all its subdirectories, yielding one</span>
<span class="sd">        :class:`File` object on each iteration, and optionally :class:`Dir` objects</span>
<span class="sd">        as well.</span>

<span class="sd">        :param pattern: limit the files returned by filename</span>
<span class="sd">        :includedirs: whether to yield directories as well as files [False]</span>
<span class="sd">        :depthfirst: as for :meth:`Dir.walk`</span>
<span class="sd">        :error_handler: as for :meth:`Dir.walk`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
        <span class="n">walker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span>
            <span class="n">depthfirst</span><span class="o">=</span><span class="n">depthfirst</span><span class="p">,</span>
            <span class="n">error_handler</span><span class="o">=</span><span class="n">error_handler</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">walker</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">includedirs</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">dir</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                            <span class="k">yield</span> <span class="nb">dir</span>
                            <span class="k">break</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">file</span>
                        <span class="k">break</span></div>

<div class="viewcode-block" id="Dir.mounted_by"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.mounted_by">[docs]</a>    <span class="k">def</span> <span class="nf">mounted_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the volume mounted on this directory, or None.</span>

<span class="sd">        :returns: a :class:`Volume` object or :const:`None`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">vol</span> <span class="ow">in</span> <span class="n">mounts</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">vol</span></div>

<div class="viewcode-block" id="Dir.mount"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.mount">[docs]</a>    <span class="k">def</span> <span class="nf">mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mount a volume on this directory. The directory must be empty or</span>
<span class="sd">        an exception is raised. eg::</span>

<span class="sd">            from winsys import fs</span>
<span class="sd">            fs.dir(&quot;c:/temp&quot;).mkdir(&quot;c_drive&quot;).mount(&quot;c:&quot;)</span>

<span class="sd">        :param vol: anything accepted by :func:`volume`</span>
<span class="sd">        :returns: this :class:`Dir`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat</span><span class="p">(</span><span class="n">includedirs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">x_fs</span><span class="p">(</span><span class="n">errctx</span><span class="o">=</span><span class="s2">&quot;Dir.mount&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="o">=</span><span class="s2">&quot;You can&#39;t mount to a non-empty directory&quot;</span><span class="p">)</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">volume</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span>
        <span class="c1">#~ for m in vol.mounts:</span>
            <span class="c1">#~ if not m.dirname:</span>
                <span class="c1">#~ raise x_fs(errctx=&quot;Dir.mount&quot;, errmsg=&quot;Volume %s already has a drive letter %s&quot; %(vol, m.root))</span>

        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">SetVolumeMountPoint</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">vol</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Dir.dismount"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.dismount">[docs]</a>    <span class="k">def</span> <span class="nf">dismount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dismount whatever volume is mounted at this directory</span>

<span class="sd">        :returns: this :class:`Dir`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">DeleteVolumeMountPoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Dir.copy"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_filepath</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">callback_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy this directory to another, which must be a directory if it</span>
<span class="sd">        exists. If it does exist, this directory&#39;s contents will be copied</span>
<span class="sd">        inside it; if it does not exist, this directory will become it.</span>
<span class="sd">        NB To copy this directory inside another, set the `target_filepath`</span>
<span class="sd">        to `other_directory + self.name`.</span>

<span class="sd">        :param target_filepath: anything accepted by :func:`entry`</span>
<span class="sd">        :param callback: cf :meth:`File.copy`</span>
<span class="sd">        :param callback_data: cf :meth:`File.copy`</span>
<span class="sd">        :returns: a :class:`Dir` object representing target_filepath</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">target_filepath</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="o">+</span> <span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">target</span><span class="o">.</span><span class="n">directory</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">x_no_such_file</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Dir.copy&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> exists but is not a directory&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="n">target_dir</span> <span class="o">=</span> <span class="n">Dir</span><span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="n">target_dir</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">target_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">target</span></div>

<div class="viewcode-block" id="Dir.delete"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete this directory, optionally including its children.</span>

<span class="sd">        :param recursive: whether to remove all subdirectories and files first</span>
<span class="sd">        :returns: this :class:`Dir`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">depthfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">RemoveDirectory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Dir.watch"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.watch">[docs]</a>    <span class="k">def</span> <span class="nf">watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a directory watcher, as per :func:`watch`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dir.zip"><a class="viewcode-back" href="../fs_dir.html#fs.Dir.zip">[docs]</a>    <span class="k">def</span> <span class="nf">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zip_filename</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Zip the directory up into a zip file. By default, the file will have the</span>
<span class="sd">        name of the directory with &quot;.zip&quot; appended and will be a sibling of the directory.</span>
<span class="sd">        Also by default a new zipfile will be created, overwriting any existing one, and</span>
<span class="sd">        standard compression will be used. Filenames are stored as relative to this dir.</span>

<span class="sd">        A different zip filename can be specific as the zip_filename parameter, and this</span>
<span class="sd">        can be appended to (if it exists) by specifying &quot;a&quot; as the mode param.</span>

<span class="sd">        The created / appended zip file is returned.</span>

<span class="sd">        :param zip_filename: The name of the zip file to hold the archive of this</span>
<span class="sd">                                                 directory and its children. [directory.zip]</span>
<span class="sd">        :param mode: cf zipfile.ZipFile</span>
<span class="sd">        :param compressions: cf zipfile.ZipFile</span>
<span class="sd">        :returns: a :class:`File` object representing the resulting zip file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zip_filename</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="n">zip_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.zip&quot;</span><span class="p">)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat</span><span class="p">():</span>
                <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">z</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">file</span><span class="p">(</span><span class="n">zip_filename</span><span class="p">)</span></div>

    <span class="n">rmdir</span> <span class="o">=</span> <span class="n">delete</span></div>

<span class="k">class</span> <span class="nc">SharedDir</span><span class="p">(</span><span class="n">Dir</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">mounted_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">dumped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">],</span> <span class="n">error_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterate over files and directories matching pattern, which can include</span>
<span class="sd">    a path. Calls win32file.FindFilesIterator under the covers, which uses</span>
<span class="sd">    FindFirstFile / FindNextFile.</span>

<span class="sd">    :pattern: A string with one or more wildcard patterns, pipe-separated</span>
<span class="sd">    :ignore: A container of specific paths to ignore</span>
<span class="sd">    :error_handler: a callable which is passed sys.exc_info and returns True if the iteration is to continue, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">_files</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">ignore</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="n">error_handler</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">f</span>

<span class="k">def</span> <span class="nf">_files</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;..&quot;</span><span class="p">],</span> <span class="n">error_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1">#</span>
    <span class="c1"># special-case &quot;.&quot;: FindFilesIterator treats a directory</span>
    <span class="c1"># name as an invitation to return only that directory.</span>
    <span class="c1"># It treats . as an invitation to return all the files</span>
    <span class="c1"># in that directory</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">Dir</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">FindFilesIterator</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">x_no_such_file</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># If this occurs, it means there&#39;s a bizarre problem</span>
        <span class="c1"># with a filename windows won&#39;t handle. Just stop</span>
        <span class="c1"># iteration.</span>
        <span class="c1">#</span>
        <span class="n">core</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Ignored no-such-file on first iteration of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1">#</span>
        <span class="c1"># If we get a trappable error at this point, there&#39;s nowhere</span>
        <span class="c1"># else to go: raise StopIteration to exit cleanly</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">error_handler</span> <span class="ow">and</span> <span class="n">error_handler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="n">parts</span> <span class="o">=</span> <span class="n">get_parts</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
    <span class="n">dirpath</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_info</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_info</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">entry</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">file_info</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="n">x_no_such_file</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># If this occurs, it means there&#39;s a bizarre problem</span>
            <span class="c1"># with a filename windows won&#39;t handle. Just stop</span>
            <span class="c1"># iteration.</span>
            <span class="c1">#</span>
            <span class="n">core</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Ignored no-such-file on first iteration of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># If the error_handler chooses to swallow this error, carry on</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">error_handler</span> <span class="ow">and</span> <span class="n">error_handler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()):</span>
                <span class="n">core</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Error </span><span class="si">%s</span><span class="s2"> ignored&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

<div class="viewcode-block" id="entry"><a class="viewcode-back" href="../fs.html#fs.entry">[docs]</a><span class="k">def</span> <span class="nf">entry</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">_file_info</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a :class:`File` or :class:`Dir` object representing this</span>
<span class="sd">    filepath.</span>

<span class="sd">    ======================================= ==================================================</span>
<span class="sd">    filepath                                Result</span>
<span class="sd">    ======================================= ==================================================</span>
<span class="sd">    :const:`None` or &quot;&quot;                     :const:`None`</span>
<span class="sd">    an :class:`Entry` or subclass object    the same object</span>
<span class="sd">    an existing file name                   a :class:`File` object representing that file</span>
<span class="sd">    an existing directory name              a :class:`Dir` object representing that directory</span>
<span class="sd">    a file name which doesn&#39;t exist         a :class:`Dir` if filepath ends with \\,</span>
<span class="sd">                                            :class:`File` otherwise</span>
<span class="sd">    ======================================= ==================================================</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_guess</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the path doesn&#39;t exist on the filesystem,</span>
<span class="sd">        guess whether it&#39;s intended to be a dir or a file</span>
<span class="sd">        by looking for a trailing slash.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">sep</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Dir</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">File</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">filepath</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">Entry</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">filepath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_file_info</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetFileAttributesW</span><span class="p">,</span> <span class="n">normalised</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="n">_file_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">attributes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_guess</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">attributes</span> <span class="o">&amp;</span> <span class="n">FILE_ATTRIBUTE</span><span class="o">.</span><span class="n">DIRECTORY</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Dir</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">_file_info</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">File</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">_file_info</span><span class="p">)</span></div>

<div class="viewcode-block" id="file"><a class="viewcode-back" href="../fs.html#fs.file">[docs]</a><span class="k">def</span> <span class="nf">file</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a :class:`File` object representing this filepath on</span>
<span class="sd">    the filepath. If filepath is already a :class:`File` object, return</span>
<span class="sd">    it unchanged otherwise ensure that the filepath doesn&#39;t point to</span>
<span class="sd">    an existing directory and return a :class:`File` object which</span>
<span class="sd">    represents it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">File</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">x_fs</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> exists but is a directory&quot;</span> <span class="o">%</span> <span class="n">filepath</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">File</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span></div>

<div class="viewcode-block" id="dir"><a class="viewcode-back" href="../fs.html#fs.dir">[docs]</a><span class="k">def</span> <span class="nf">dir</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a :class:`Dir` object representing this filepath on</span>
<span class="sd">    the filepath. If filepath is already a :class:`Dir` object, return</span>
<span class="sd">    it unchanged otherwise ensure that the filepath doesn&#39;t point to</span>
<span class="sd">    an existing file and return a :class:`Dir` object which</span>
<span class="sd">    represents it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Dir</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">File</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">x_fs</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;dir&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> exists but is a file&quot;</span> <span class="o">%</span> <span class="n">filepath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">UNC</span><span class="p">,</span> <span class="n">unicode</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">root</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">SharedDir</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Dir</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span></div>

<div class="viewcode-block" id="glob"><a class="viewcode-back" href="../fs.html#fs.glob">[docs]</a><span class="k">def</span> <span class="nf">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mimic the built-in glob.glob functionality as a generator,</span>
<span class="sd">    optionally ignoring access errors.</span>

<span class="sd">    :param pattern: passed to :func:`files`</span>
<span class="sd">    :returns: yields a :class:`FilePath` object for each matching file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">files</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span></div>

<div class="viewcode-block" id="listdir"><a class="viewcode-back" href="../fs.html#fs.listdir">[docs]</a><span class="k">def</span> <span class="nf">listdir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mimic the built-in os.list functionality as a generator,</span>
<span class="sd">    optionally ignoring access errors.</span>

<span class="sd">    :param d: anything accepted by :func:`dir`</span>
<span class="sd">    :returns: yield the name of each file in directory d</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="walk"><a class="viewcode-back" href="../fs.html#fs.walk">[docs]</a><span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">depthfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Walk the directory tree starting from root, optionally ignoring</span>
<span class="sd">    access errors.</span>

<span class="sd">    :param root: anything accepted by :func:`dir`</span>
<span class="sd">    :param depthfirst: passed to :meth:`Dir.walk`</span>
<span class="sd">    :param error_handler: passed to :meth:`Dir.walk`</span>
<span class="sd">    :returns: as :meth:`Dir.walk`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">depthfirst</span><span class="o">=</span><span class="n">depthfirst</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="n">error_handler</span><span class="p">)</span></div>

<div class="viewcode-block" id="flat"><a class="viewcode-back" href="../fs.html#fs.flat">[docs]</a><span class="k">def</span> <span class="nf">flat</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">includedirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">depthfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterate over a flattened version of the directory tree starting</span>
<span class="sd">    from root. Implemented via :meth:`Dir.flat`.</span>

<span class="sd">    :param root: anything accepted by :func:`dir`</span>
<span class="sd">    :param pattern: passed to :meth:`Dir.flat`</span>
<span class="sd">    :param includedirs: passed to :meth:`Dir.flat`</span>
<span class="sd">    :param depthfirst: passed to :meth:`Dir.flat`</span>
<span class="sd">    :param error_handler: passed to :meth:`Dir.flat`</span>
<span class="sd">    :returns: as :meth:`Dir.flat`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">(</span>
        <span class="n">pattern</span><span class="p">,</span>
        <span class="n">includedirs</span><span class="o">=</span><span class="n">includedirs</span><span class="p">,</span>
        <span class="n">depthfirst</span><span class="o">=</span><span class="n">depthfirst</span><span class="p">,</span>
        <span class="n">error_handler</span><span class="o">=</span><span class="n">error_handler</span>
    <span class="p">)</span></div>

<span class="k">def</span> <span class="nf">progress_wrapper</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_progress_wrapper</span><span class="p">(</span>
        <span class="n">TotalFileSize</span><span class="p">,</span> <span class="n">TotalBytesTransferred</span><span class="p">,</span>
        <span class="n">StreamSize</span><span class="p">,</span> <span class="n">StreamBytesTransferred</span><span class="p">,</span> <span class="n">StreamNumber</span><span class="p">,</span>
        <span class="n">CallbackReason</span><span class="p">,</span>
        <span class="n">SourceFile</span><span class="p">,</span> <span class="n">DestinationFile</span><span class="p">,</span>
        <span class="n">data</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">(</span><span class="n">TotalFileSize</span><span class="p">,</span> <span class="n">TotalBytesTransferred</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">PROGRESS</span><span class="o">.</span><span class="n">CANCEL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PROGRESS</span><span class="o">.</span><span class="n">CONTINUE</span>

    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_progress_wrapper</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="move"><a class="viewcode-back" href="../fs.html#fs.move">[docs]</a><span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="n">source_filepath</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Move one :class:`Entry` object to another, implemented via :meth:`File.move` or :meth:`Dir.move`</span>

<span class="sd">    :param source_filepath: anything accepted by :func:`entry`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">entry</span><span class="p">(</span><span class="n">source_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="copy"><a class="viewcode-back" href="../fs.html#fs.copy">[docs]</a><span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">source_filepath</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy one :class:`Entry` object to another, implemented via :meth:`File.copy` or :meth:`Dir.copy`</span>

<span class="sd">    :param source_filepath: anything accepted by :func:`entry`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">entry</span><span class="p">(</span><span class="n">source_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="delete"><a class="viewcode-back" href="../fs.html#fs.delete">[docs]</a><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deletes a :class:`Entry` object, implemented via :meth:`File.delete` or :meth:`Dir.delete`</span>

<span class="sd">    :param filepath: anything accepted by :func:`entry`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">entry</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></div>

<div class="viewcode-block" id="rmdir"><a class="viewcode-back" href="../fs.html#fs.rmdir">[docs]</a><span class="k">def</span> <span class="nf">rmdir</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mimic the os.rmdir functionality, optionally recursing</span>

<span class="sd">    :param filepath: anything accepted by :func:`dir`</span>
<span class="sd">    :param recursive: passed to :meth:`Dir.delete`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span></div>

<div class="viewcode-block" id="attributes"><a class="viewcode-back" href="../fs.html#fs.attributes">[docs]</a><span class="k">def</span> <span class="nf">attributes</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an :class:`constants.Attributes` object representing the file attributes</span>
<span class="sd">    of filepath, implemented via :meth:`Entry.attributes`</span>

<span class="sd">    :param filepath: anything accepted by :func:`entry`</span>
<span class="sd">    :returns: an :class:`constants.Attributes` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">entry</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">attributes</span></div>

<div class="viewcode-block" id="exists"><a class="viewcode-back" href="../fs.html#fs.exists">[docs]</a><span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mimic os.path.exists, implemented via the :class:`Entry` boolean mechanism</span>

<span class="sd">    :param filepath: anything accepted by :func:`entry`</span>
<span class="sd">    :returns: :const:`True` if filepath exists, :const:`False` otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">entry</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span></div>

<div class="viewcode-block" id="mkdir"><a class="viewcode-back" href="../fs.html#fs.mkdir">[docs]</a><span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mimic os.mkdir, implemented via :meth:`Dir.create`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="touch"><a class="viewcode-back" href="../fs.html#fs.touch">[docs]</a><span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update a file&#39;s modification time, creating it if it</span>
<span class="sd">    does not exist, implemented via :meth:`File.create`</span>

<span class="sd">    :param filepath: anything accepted by :func:`file`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">()</span></div>

<div class="viewcode-block" id="mount"><a class="viewcode-back" href="../fs.html#fs.mount">[docs]</a><span class="k">def</span> <span class="nf">mount</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">vol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mount vol at filepath, implemented via :meth:`Dir.mount`</span>

<span class="sd">    :param filepath: anything accepted by :func:`dir`</span>
<span class="sd">    :param vol: passed to :meth:`Dir.mount`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span></div>

<div class="viewcode-block" id="dismount"><a class="viewcode-back" href="../fs.html#fs.dismount">[docs]</a><span class="k">def</span> <span class="nf">dismount</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dismount the volume at filepath, implemented via :meth:`Dir.dismount`</span>

<span class="sd">    :param filepath: anything accepted by :func:`dir`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dir</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">dismount</span><span class="p">()</span></div>

<div class="viewcode-block" id="zip"><a class="viewcode-back" href="../fs.html#fs.zip">[docs]</a><span class="k">def</span> <span class="nf">zip</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create and return a zip archive of filepath, implemented via :meth:`File.zip` or :meth:`Dir.zip`</span>

<span class="sd">    :param filepath: anything accepted by :func:`entry`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">entry</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="drive"><a class="viewcode-back" href="../fs.html#fs.drive">[docs]</a><span class="k">def</span> <span class="nf">drive</span><span class="p">(</span><span class="n">drive</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a :class:`Drive` object representing drive</span>

<span class="sd">    ======================================= ==================================================</span>
<span class="sd">    drive                                   Result</span>
<span class="sd">    ======================================= ==================================================</span>
<span class="sd">    :const:`None`                           :const:`None`</span>
<span class="sd">    an :class:`Drive` or subclass object    the same object</span>
<span class="sd">    a drive letter                          a :class:`Drive` object</span>
<span class="sd">    ======================================= ==================================================</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">drive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span> <span class="n">Drive</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">drive</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Drive</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span></div>

<div class="viewcode-block" id="drives"><a class="viewcode-back" href="../fs.html#fs.drives">[docs]</a><span class="k">def</span> <span class="nf">drives</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Iterate over all the drive letters in the system, yielding a :class:`Drive` object</span>
<span class="sd">    representing each one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">drive</span> <span class="ow">in</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">GetLogicalDriveStrings</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">Drive</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span></div>

<div class="viewcode-block" id="volume"><a class="viewcode-back" href="../fs.html#fs.volume">[docs]</a><span class="k">def</span> <span class="nf">volume</span><span class="p">(</span><span class="n">volume</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return a :class:`Volume` object corresponding to volume</span>

<span class="sd">    ======================================= ==================================================</span>
<span class="sd">    volume                                  Result</span>
<span class="sd">    ======================================= ==================================================</span>
<span class="sd">    :const:`None`                           :const:`None`</span>
<span class="sd">    an :class:`Volume` or subclass object   the same object</span>
<span class="sd">    a volume name \\?\Volume...             a :class:`Volume` object representing that volume</span>
<span class="sd">    a directory name                        a :class:`Volume` object representing the volume</span>
<span class="sd">                                            at that mountpoint</span>
<span class="sd">    ======================================= ==================================================</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">volume</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="n">Volume</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">volume</span>
    <span class="k">elif</span> <span class="n">volume</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">?\Volume&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Volume</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Volume</span><span class="p">(</span><span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetVolumeNameForVolumeMountPoint</span><span class="p">,</span> <span class="n">volume</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="o">+</span> <span class="n">sep</span><span class="p">))</span></div>

<div class="viewcode-block" id="volumes"><a class="viewcode-back" href="../fs.html#fs.volumes">[docs]</a><span class="k">def</span> <span class="nf">volumes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Iterate over all the volumes in the system, yielding a :class:`Volume` object</span>
<span class="sd">    representing each one.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hSearch</span><span class="p">,</span> <span class="n">volume_name</span> <span class="o">=</span> <span class="n">_kernel32</span><span class="o">.</span><span class="n">FindFirstVolume</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">Volume</span><span class="p">(</span><span class="n">volume_name</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">volume_name</span> <span class="o">=</span> <span class="n">_kernel32</span><span class="o">.</span><span class="n">FindNextVolume</span><span class="p">(</span><span class="n">hSearch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">volume_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Volume</span><span class="p">(</span><span class="n">volume_name</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">share</span><span class="p">(</span><span class="n">share</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a :class:`Share` object corresponding to share</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">share</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">share</span><span class="p">,</span> <span class="n">Share</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">share</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">sep</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">LEGAL_FILECHARS</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">LEGAL_FILECHARS</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">share</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Share</span><span class="p">(</span><span class="o">*</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">x_fs</span><span class="p">(</span><span class="s2">&quot;Invalid share name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">share</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">shares</span><span class="p">(</span><span class="n">servername</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterate over all the shares in a system, yielding a :class:`Share` object</span>
<span class="sd">    representing each one</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">infos</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">hResume</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32net</span><span class="o">.</span><span class="n">NetShareEnum</span><span class="p">,</span> <span class="n">servername</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">Share</span><span class="p">(</span><span class="n">servername</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;netname&#39;</span><span class="p">])</span>
    <span class="k">while</span> <span class="n">hResume</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">infos</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">hResume</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32net</span><span class="o">.</span><span class="n">NetShareEnum</span><span class="p">,</span> <span class="n">servername</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hResume</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Share</span><span class="p">(</span><span class="n">servername</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;netname&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="mounts"><a class="viewcode-back" href="../fs.html#fs.mounts">[docs]</a><span class="k">def</span> <span class="nf">mounts</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Iterate over all mounted volume mountpoints in the system, yielding a</span>
<span class="sd">    (:class:`Dir`, :class:`Volume`) pair for each one, eg::</span>

<span class="sd">        from winsys import fs</span>
<span class="sd">        drive_volumes = dict(fs.mounts())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">mounts</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Dir</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">v</span></div>

<span class="k">class</span> <span class="nc">_DirWatcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">WATCH_FOR</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="n">FILE_NOTIFY_CHANGE</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">8192</span>
    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">500</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">subdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">watch_for</span><span class="o">=</span><span class="n">WATCH_FOR</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="n">stop_event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdirs</span> <span class="o">=</span> <span class="n">subdirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">watch_for</span> <span class="o">=</span> <span class="n">watch_for</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlapped</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">pywintypes</span><span class="o">.</span><span class="n">OVERLAPPED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlapped</span><span class="o">.</span><span class="n">hEvent</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32event</span><span class="o">.</span><span class="n">CreateEvent</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">AllocateReadBuffer</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hDir</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span>
            <span class="n">win32file</span><span class="o">.</span><span class="n">CreateFile</span><span class="p">,</span>
            <span class="n">normalised</span><span class="p">(</span><span class="n">root</span><span class="p">),</span>
            <span class="n">FILE_ACCESS</span><span class="o">.</span><span class="n">LIST_DIRECTORY</span><span class="p">,</span>
            <span class="c1">#</span>
            <span class="c1"># This must allow RWD otherwises files in</span>
            <span class="c1"># the dir will be constrained.</span>
            <span class="c1">#</span>
            <span class="n">FILE_SHARE</span><span class="o">.</span><span class="n">READ</span> <span class="o">|</span> <span class="n">FILE_SHARE</span><span class="o">.</span><span class="n">WRITE</span> <span class="o">|</span> <span class="n">FILE_SHARE</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">FILE_CREATION</span><span class="o">.</span><span class="n">OPEN_EXISTING</span><span class="p">,</span>
            <span class="n">FILE_FLAG</span><span class="o">.</span><span class="n">BACKUP_SEMANTICS</span> <span class="o">|</span> <span class="n">FILE_FLAG</span><span class="o">.</span><span class="n">OVERLAPPED</span><span class="p">,</span>
            <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">overlapped</span><span class="o">.</span><span class="n">hEvent</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">stop_event</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stop_event</span><span class="o">.</span><span class="n">pyobject</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wrapped</span><span class="p">(</span>
            <span class="n">win32file</span><span class="o">.</span><span class="n">ReadDirectoryChangesW</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hDir</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdirs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">watch_for</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overlapped</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">stopped_by</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span>
                <span class="n">win32event</span><span class="o">.</span><span class="n">WaitForMultipleObjects</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">TIMEOUT</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">stopped_by</span> <span class="o">==</span> <span class="n">win32event</span><span class="o">.</span><span class="n">WAIT_OBJECT_0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">StopIteration</span>
            <span class="k">elif</span> <span class="n">stopped_by</span> <span class="o">==</span> <span class="n">win32event</span><span class="o">.</span><span class="n">WAIT_OBJECT_0</span><span class="p">:</span>
                <span class="n">n_bytes</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">GetOverlappedResult</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlapped</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">last_result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">old_file</span> <span class="o">=</span> <span class="n">new_file</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32file</span><span class="o">.</span><span class="n">FILE_NOTIFY_INFORMATION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">FILE_ACTION</span><span class="o">.</span><span class="n">ADDED</span><span class="p">:</span>
                        <span class="n">new_file</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">FILE_ACTION</span><span class="o">.</span><span class="n">REMOVED</span><span class="p">:</span>
                        <span class="n">old_file</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">FILE_ACTION</span><span class="o">.</span><span class="n">MODIFIED</span><span class="p">:</span>
                        <span class="n">old_file</span> <span class="o">=</span> <span class="n">new_file</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">FILE_ACTION</span><span class="o">.</span><span class="n">RENAMED_OLD_NAME</span><span class="p">:</span>
                        <span class="n">old_file</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                        <span class="n">action</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="n">FILE_ACTION</span><span class="o">.</span><span class="n">RENAMED_NEW_NAME</span><span class="p">:</span>
                        <span class="n">new_file</span> <span class="o">=</span> <span class="n">entry</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">action</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">old_file</span><span class="p">,</span> <span class="n">new_file</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">last_result</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changes</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
    <span class="fm">__next__</span> <span class="o">=</span> <span class="nb">next</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hDir</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="watch"><a class="viewcode-back" href="../fs.html#fs.watch">[docs]</a><span class="k">def</span> <span class="nf">watch</span><span class="p">(</span>
    <span class="n">root</span><span class="p">,</span>
    <span class="n">subdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">watch_for</span><span class="o">=</span><span class="n">_DirWatcher</span><span class="o">.</span><span class="n">WATCH_FOR</span><span class="p">,</span>
    <span class="n">buffer_size</span><span class="o">=</span><span class="n">_DirWatcher</span><span class="o">.</span><span class="n">BUFFER_SIZE</span><span class="p">,</span>
    <span class="n">stop_event</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an iterator which returns a file change on every iteration.</span>
<span class="sd">    The file change comes in the form: action, old_filename, new_filename.</span>
<span class="sd">    action is one of the :const:`FILE_ACTION` constants, while the filenames</span>
<span class="sd">    speak for themselves. The filenames will be the same if the file has been</span>
<span class="sd">    updated. If the file is new, old_filename will be None; if it has been</span>
<span class="sd">    deleted, new_filename will be None; if it has been renamed, they will</span>
<span class="sd">    be different::</span>

<span class="sd">        from winsys import fs</span>
<span class="sd">        watcher = fs.watch(&quot;c:/temp&quot;, subdirs=True)</span>
<span class="sd">        for action, old_filename, new_filename in watcher:</span>
<span class="sd">            if action == fs.FILE_ACTION.ADDED:</span>
<span class="sd">                print new_filename, &quot;added&quot;</span>
<span class="sd">            elif action == fs.FILE_ACTION.REMOVED:</span>
<span class="sd">                print old_filename, &quot;removed&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_DirWatcher</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">watch_for</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span> <span class="n">stop_event</span><span class="p">)</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Watching&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
    <span class="n">watcher</span> <span class="o">=</span> <span class="n">watch</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">old_filename</span><span class="p">,</span> <span class="n">new_filename</span> <span class="ow">in</span> <span class="n">watcher</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="n">FILE_ACTION</span><span class="o">.</span><span class="n">ADDED</span><span class="p">,</span> <span class="n">FILE_ACTION</span><span class="o">.</span><span class="n">MODIFIED</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%10s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">FILE_ACTION</span><span class="o">.</span><span class="n">name_from_value</span><span class="p">(</span><span class="n">action</span><span class="p">),</span> <span class="n">new_filename</span><span class="p">,</span> <span class="n">entry</span><span class="p">(</span><span class="n">new_filename</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">watcher</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/cpython2.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../contents.html">WinSys 1.0beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013, Tim Golden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.2.
    </div>
  </body>
</html>