
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>registry &#8212; WinSys 1.0beta documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../contents.html">WinSys 1.0beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for registry</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The registry consists of a series of roots from each of which descends</span>
<span class="sd">a tree of keys and values. Each key has an anonymous (default) value</span>
<span class="sd">and optionally a set of named values, each of which has a particular</span>
<span class="sd">type (string, number etc.).</span>

<span class="sd">For convenience in accessing registry keys and values, the module</span>
<span class="sd">implements the idea of a registry moniker which has the form:</span>
<span class="sd">:const:`[\\\\computer\\]HKEY[\\subkey path][:[value]]`. For example::</span>

<span class="sd">    from winsys import registry</span>

<span class="sd">    #</span>
<span class="sd">    # The value of the Version item in the HKLM\Software\Python key on SVR01</span>
<span class="sd">    #</span>
<span class="sd">    registry.registry(r&quot;\\SVR01\HKEY_LOCAL_MACHINE\Software\Python:Version&quot;)</span>

<span class="sd">    #</span>
<span class="sd">    # The Control Panel\Desktop key in HKEY_CURRENT_USER on the current machine</span>
<span class="sd">    #</span>
<span class="sd">    registry.registry(r&quot;HKCU\Control Panel\Desktop&quot;)</span>

<span class="sd">The key function here is :func:`registry` which is a factory</span>
<span class="sd">returning a :class:`Registry` object which contains</span>
<span class="sd">most of the useful functionality in the module. However, the same</span>
<span class="sd">functionality is replicated at module level in many cases for</span>
<span class="sd">convenience.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">winerror</span>
<span class="kn">import</span> <span class="nn">win32api</span>
<span class="kn">import</span> <span class="nn">win32con</span>
<span class="kn">import</span> <span class="nn">pywintypes</span>

<span class="kn">from</span> <span class="nn">winsys._compat</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">winsys</span> <span class="kn">import</span> <span class="n">constants</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">security</span><span class="p">,</span> <span class="n">utils</span>

<span class="k">class</span> <span class="nc">RegistryConstants</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">name_from_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">,</span> <span class="n">patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Find the longest name in the set of constants (optionally qualified by pattern)</span>
<span class="sd">        which matches value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span>
                <span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">),</span>
                <span class="n">key</span><span class="o">=</span><span class="nb">len</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="n">core</span><span class="o">.</span><span class="n">UNSET</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No constant matching name </span><span class="si">%s</span><span class="s2"> and value </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>

<span class="n">REGISTRY_HIVE</span> <span class="o">=</span> <span class="n">RegistryConstants</span><span class="o">.</span><span class="n">from_list</span><span class="p">([</span>
    <span class="s2">&quot;HKEY_CLASSES_ROOT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HKEY_CURRENT_CONFIG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HKEY_CURRENT_USER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HKEY_DYN_DATA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HKEY_LOCAL_MACHINE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HKEY_PERFORMANCE_DATA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HKEY_PERFORMANCE_NLSTEXT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HKEY_PERFORMANCE_TEXT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HKEY_USERS&quot;</span><span class="p">,</span>
<span class="p">],</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32con</span><span class="p">)</span>
<span class="n">REGISTRY_HIVE</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">HKLM</span> <span class="o">=</span> <span class="n">REGISTRY_HIVE</span><span class="o">.</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="p">,</span>
    <span class="n">HKCU</span> <span class="o">=</span> <span class="n">REGISTRY_HIVE</span><span class="o">.</span><span class="n">HKEY_CURRENT_USER</span><span class="p">,</span>
    <span class="n">HKCR</span> <span class="o">=</span> <span class="n">REGISTRY_HIVE</span><span class="o">.</span><span class="n">HKEY_CLASSES_ROOT</span><span class="p">,</span>
    <span class="n">HKU</span> <span class="o">=</span> <span class="n">REGISTRY_HIVE</span><span class="o">.</span><span class="n">HKEY_USERS</span>
<span class="p">))</span>
<span class="n">REGISTRY_HIVE</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Registry hives (root keys) including common aliases (HKCU, HKLM, etc.)&quot;</span><span class="p">)</span>
<span class="n">REGISTRY_ACCESS</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_list</span><span class="p">([</span>
    <span class="s2">&quot;KEY_ALL_ACCESS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_CREATE_LINK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_CREATE_SUB_KEY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_ENUMERATE_SUB_KEYS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_EXECUTE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_NOTIFY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_QUERY_VALUE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_READ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_SET_VALUE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_WOW64_32KEY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_WOW64_64KEY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;KEY_WRITE&quot;</span><span class="p">,</span>
<span class="p">],</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32con</span><span class="p">)</span>
<span class="n">REGISTRY_ACCESS</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Registry-specific access rights&quot;</span><span class="p">)</span>
<span class="n">REGISTRY_VALUE_TYPE</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">from_list</span><span class="p">([</span>
    <span class="s2">&quot;REG_BINARY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_DWORD&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_DWORD_LITTLE_ENDIAN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_DWORD_BIG_ENDIAN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_EXPAND_SZ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_LINK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_MULTI_SZ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_NONE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_QWORD&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_QWORD_LITTLE_ENDIAN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;REG_SZ&quot;</span><span class="p">,</span>
<span class="p">],</span> <span class="n">namespace</span><span class="o">=</span><span class="n">win32con</span><span class="p">)</span>
<span class="n">REGISTRY_VALUE_TYPE</span><span class="o">.</span><span class="n">doc</span><span class="p">(</span><span class="s2">&quot;Registry value data types&quot;</span><span class="p">)</span>

<span class="n">PyHANDLE</span> <span class="o">=</span> <span class="n">pywintypes</span><span class="o">.</span><span class="n">HANDLEType</span>

<div class="viewcode-block" id="x_registry"><a class="viewcode-back" href="../registry.html#registry.x_registry">[docs]</a><span class="k">class</span> <span class="nc">x_registry</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">x_winsys</span><span class="p">):</span>
    <span class="s2">&quot;Base exception for all registry exceptions&quot;</span></div>

<div class="viewcode-block" id="x_moniker"><a class="viewcode-back" href="../registry.html#registry.x_moniker">[docs]</a><span class="k">class</span> <span class="nc">x_moniker</span><span class="p">(</span><span class="n">x_registry</span><span class="p">):</span>
    <span class="s2">&quot;Base exception for problems with monikers&quot;</span></div>

<div class="viewcode-block" id="x_moniker_ill_formed"><a class="viewcode-back" href="../registry.html#registry.x_moniker_ill_formed">[docs]</a><span class="k">class</span> <span class="nc">x_moniker_ill_formed</span><span class="p">(</span><span class="n">x_moniker</span><span class="p">):</span>
    <span class="s2">&quot;Raised when a moniker does not match the correct format&quot;</span></div>

<div class="viewcode-block" id="x_moniker_no_root"><a class="viewcode-back" href="../registry.html#registry.x_moniker_no_root">[docs]</a><span class="k">class</span> <span class="nc">x_moniker_no_root</span><span class="p">(</span><span class="n">x_moniker</span><span class="p">):</span>
    <span class="s2">&quot;Raised when a moniker has no Hive in the first or second position&quot;</span></div>

<span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>

<span class="n">WINERROR_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_PATH_NOT_FOUND</span> <span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_not_found</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_FILE_NOT_FOUND</span> <span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_not_found</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_NO_MORE_ITEMS</span> <span class="p">:</span> <span class="ne">StopIteration</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_ACCESS_DENIED</span> <span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_access_denied</span><span class="p">,</span>
    <span class="n">winerror</span><span class="o">.</span><span class="n">ERROR_INVALID_HANDLE</span> <span class="p">:</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_invalid_handle</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">wrapped</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">wrapper</span><span class="p">(</span><span class="n">WINERROR_MAP</span><span class="p">,</span> <span class="n">x_registry</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_moniker</span><span class="p">(</span><span class="n">moniker</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Take a registry moniker and return the computer, root key, subkey path and value label.</span>
<span class="sd">    NB: neither the computer nor the registry key need exist; they</span>
<span class="sd">    need simply to be of the right format. The slashes must be backslashes (since</span>
<span class="sd">    registry key names can contain forward slashes). accept_value is mostly used</span>
<span class="sd">    internally to indicate that a key search is going on, where a colon is to be</span>
<span class="sd">    considered part of the key name; if it is True, then the colon is to be</span>
<span class="sd">    considered a value separator.</span>

<span class="sd">    The moniker must be of the form:</span>

<span class="sd">        [\\computer\]HKEY[\subkey path][:value]</span>

<span class="sd">    Valid monikers are:</span>
<span class="sd">        \\SVR01\HKEY_LOCAL_MACHINE\Software\Python:Version</span>
<span class="sd">        -&gt; &quot;SVR01&quot;, 0x80000002, &quot;Software\Python&quot;, &quot;Version&quot;</span>

<span class="sd">        HKEY_CURRENT_USER\Software</span>
<span class="sd">        -&gt; &quot;&quot;, 0x80000001, &quot;Software&quot;, None</span>

<span class="sd">        HKEY_CURRENT_USER\Software\Python:</span>
<span class="sd">        -&gt; &quot;&quot;, 0x80000001, &quot;Software\Python&quot;, &quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">accept_value</span><span class="p">:</span>
        <span class="n">moniker_parser</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:</span><span class="se">\\\\</span><span class="s2">([^</span><span class="se">\\</span><span class="s2">]+)</span><span class="se">\\</span><span class="s2">)?([^:]+)(:?)(.*)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">moniker_parser</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:</span><span class="se">\\\\</span><span class="s2">([^</span><span class="se">\\</span><span class="s2">]+)</span><span class="se">\\</span><span class="s2">)?(.*)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>

    <span class="n">matcher</span> <span class="o">=</span> <span class="n">moniker_parser</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">moniker</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matcher</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">x_moniker_ill_formed</span><span class="p">(</span><span class="n">errctx</span><span class="o">=</span><span class="s2">&quot;_parse_moniker&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="o">=</span><span class="s2">&quot;Ill-formed moniker: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">moniker</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">accept_value</span><span class="p">:</span>
        <span class="n">computer</span><span class="p">,</span> <span class="n">keypath</span><span class="p">,</span> <span class="n">colon</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">computer</span><span class="p">,</span> <span class="n">keypath</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="n">colon</span> <span class="o">=</span> <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">keypath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>

    <span class="n">root</span> <span class="o">=</span> <span class="n">path</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">key0</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">REGISTRY_HIVE</span><span class="p">[</span><span class="n">key0</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">key1</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">REGISTRY_HIVE</span><span class="p">[</span><span class="n">key1</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">x_moniker_no_root</span><span class="p">(</span><span class="n">errctx</span><span class="o">=</span><span class="s2">&quot;_parse_moniker&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="o">=</span><span class="s2">&quot;A registry hive must be the first or second segment in moniker&quot;</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># If a value is indicated (by a colon) but none is supplied,</span>
    <span class="c1"># use &quot;&quot; to indicate that the default value is requested.</span>
    <span class="c1"># Otherwise use None to indicate that no value is requested</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">colon</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">computer</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span>

<div class="viewcode-block" id="create_moniker"><a class="viewcode-back" href="../registry.html#registry.create_moniker">[docs]</a><span class="k">def</span> <span class="nf">create_moniker</span><span class="p">(</span><span class="n">computer</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a valid registry moniker from component parts. Computer</span>
<span class="sd">    is optional but root and path must be specified.</span>

<span class="sd">    :param computer: (optional) name of a remote computer or &quot;.&quot; or :const:`None`</span>
<span class="sd">    :param root: name or value from REGISTRY_HIVE</span>
<span class="sd">    :param path: backslash-separated registry path</span>
<span class="sd">    :param value: name of a value on that path. An empty string refers to the default value.</span>
<span class="sd">    :returns: a valid moniker string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">root</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REGISTRY_HIVE</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">REGISTRY_HIVE</span><span class="o">.</span><span class="n">name_from_value</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">fullpath</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">root</span><span class="p">]</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">computer</span><span class="p">:</span>
        <span class="n">moniker</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="si">%s</span><span class="s2">\</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">computer</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">moniker</span> <span class="o">=</span> <span class="n">fullpath</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">moniker</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">moniker</span></div>

<div class="viewcode-block" id="Registry"><a class="viewcode-back" href="../registry.html#registry.Registry">[docs]</a><span class="k">class</span> <span class="nc">Registry</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">_WinSysObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represent a registry key (including one of the roots) giving</span>
<span class="sd">    access to its subkeys and values as well as its security and walking</span>
<span class="sd">    its subtrees. The key is True if it exists, False otherwise.</span>

<span class="sd">    When access rights are supplied to any function, they can either be an</span>
<span class="sd">    integer representing a bitmask, or one or more letters corresponding to</span>
<span class="sd">    the :attr:`ACCESS` mapping. The default access is &quot;F&quot; indicating</span>
<span class="sd">    Full Control.</span>

<span class="sd">    Note that addition and attribute / item getting and setting are overridden for convenience</span>
<span class="sd">    in accessing subkeys and values as follows:</span>

<span class="sd">    * Adding a string to a :class:`Registry` object will result in a new object representing</span>
<span class="sd">        the subkey of that name::</span>

<span class="sd">            from winsys import registry</span>
<span class="sd">            software = registry.registry(r&quot;HKLM\Software&quot;)</span>
<span class="sd">            software + r&quot;Python\Pythoncore&quot; == registry.registry (r&quot;HKLM\Software\Python\Pythoncore&quot;)</span>

<span class="sd">    * Getting an attribute of a :class:`Registry` object will return a value</span>
<span class="sd">        if one exists, a key otherwise (or will raise AttributeError). For a key</span>
<span class="sd">        name this is the same as calling :meth:`get_key` or adding the key name</span>
<span class="sd">        as above. For a value name, this is the same as calling :meth:`get_value`</span>

<span class="sd">    * Setting an attribute always writes a value, even if a key of that</span>
<span class="sd">        name already exists. This is equivalent to calling :meth:`set_value`.</span>

<span class="sd">    * Deleting an attribute will attempts to delete a value if one exists,</span>
<span class="sd">        otherwise it will delete a key of that name. This is equivalent to</span>
<span class="sd">        calling :meth:`del_value` or :meth:`delete`.</span>

<span class="sd">        ::</span>

<span class="sd">            from winsys import registry</span>
<span class="sd">            python = registry.registry(r&quot;HKLM\Software\Python&quot;)</span>
<span class="sd">            python.testing = 4</span>
<span class="sd">            python.get_value(&quot;testing&quot;) == 4</span>
<span class="sd">            python.testing == python[&#39;testing&#39;]</span>
<span class="sd">            del python.testing</span>

<span class="sd">    * To create a key, call :meth:`create` or the module-level :func:`create` function.</span>

<span class="sd">    * To delete a key, call its :meth:`delete` method or the module level</span>
<span class="sd">        :func:`delete` function.</span>

<span class="sd">        ::</span>

<span class="sd">            from winsys import registry</span>
<span class="sd">            winsys = registry.registry(r&quot;hklm\software\winsys&quot;).create()</span>
<span class="sd">            winsys.test_value = 4</span>
<span class="sd">            registry.registry(r&quot;hklm\software\winsys:test_value&quot;) == 4</span>
<span class="sd">            registry.delete(winsys)</span>
<span class="sd">            # or winsys.delete()</span>
<span class="sd">            # or registry.registry(r&quot;hklm\software&quot;).delete(&quot;winsys&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ACCESS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Q&quot;</span> <span class="p">:</span> <span class="n">REGISTRY_ACCESS</span><span class="o">.</span><span class="n">KEY_QUERY_VALUE</span><span class="p">,</span>
        <span class="s2">&quot;D&quot;</span> <span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">ACCESS</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span>
        <span class="s2">&quot;R&quot;</span> <span class="p">:</span> <span class="n">REGISTRY_ACCESS</span><span class="o">.</span><span class="n">KEY_READ</span><span class="p">,</span>
        <span class="s2">&quot;W&quot;</span> <span class="p">:</span> <span class="n">REGISTRY_ACCESS</span><span class="o">.</span><span class="n">KEY_WRITE</span><span class="p">,</span>
        <span class="s2">&quot;C&quot;</span> <span class="p">:</span> <span class="n">REGISTRY_ACCESS</span><span class="o">.</span><span class="n">KEY_READ</span> <span class="o">|</span> <span class="n">REGISTRY_ACCESS</span><span class="o">.</span><span class="n">KEY_WRITE</span><span class="p">,</span>
        <span class="s2">&quot;F&quot;</span> <span class="p">:</span> <span class="n">REGISTRY_ACCESS</span><span class="o">.</span><span class="n">KEY_ALL_ACCESS</span><span class="p">,</span>
        <span class="s2">&quot;S&quot;</span> <span class="p">:</span> <span class="n">constants</span><span class="o">.</span><span class="n">ACCESS</span><span class="o">.</span><span class="n">READ_CONTROL</span> <span class="o">|</span> <span class="n">constants</span><span class="o">.</span><span class="n">ACCESS</span><span class="o">.</span><span class="n">WRITE_DAC</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="sd">&quot;&quot;&quot;Mapping between characters and access rights:</span>

<span class="sd">    * Q - Query</span>
<span class="sd">    * D - Delete</span>
<span class="sd">    * R - Read</span>
<span class="sd">    * W - Write</span>
<span class="sd">    * C - Change (R|W)</span>
<span class="sd">    * F - Full Control</span>
<span class="sd">    * S - Security</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEFAULT_ACCESS</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moniker</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">DEFAULT_ACCESS</span><span class="p">):</span>
        <span class="n">core</span><span class="o">.</span><span class="n">_WinSysObject</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;hKey&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;moniker&quot;</span><span class="p">,</span> <span class="n">unicode</span><span class="p">(</span><span class="n">moniker</span><span class="p">))</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">_parse_moniker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moniker</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;access&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access</span><span class="p">(</span><span class="n">access</span><span class="p">))</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">moniker</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">moniker</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_access</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">access</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Conversion function which returns an integer representing a security access</span>
<span class="sd">        bit pattern. Uses the class&#39;s ACCESS map to translate letters to integers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">access</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">access</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ACCESS</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">access</span><span class="o">.</span><span class="n">upper</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">access</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">))</span>

<div class="viewcode-block" id="Registry.__add__"><a class="viewcode-back" href="../registry.html#registry.Registry.__add__">[docs]</a>    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow a key to be added to an existing moniker.</span>

<span class="sd">        :param path: can be a simple name or a backslash-separated relative path</span>
<span class="sd">        :returns: a :class:`Registry` object for the new path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moniker</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># path is unlikely to be empty for a specific call,</span>
            <span class="c1"># but this functionality is used by the create and</span>
            <span class="c1"># delete methods which refer to the existing class</span>
            <span class="c1"># by default.</span>
            <span class="c1">#</span>
            <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Registry.pyobject"><a class="viewcode-back" href="../registry.html#registry.Registry.pyobject">[docs]</a>    <span class="k">def</span> <span class="nf">pyobject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lazily return an internal registry key handle according to the instance&#39;s</span>
<span class="sd">        access requirements.</span>

<span class="sd">        :raises: :exc:`x_not_found` if the registry path the key refers to does not exist</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hKey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hKey</span><span class="p">,</span> <span class="n">moniker</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moniker</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;hKey&quot;</span><span class="p">,</span> <span class="n">hKey</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hKey</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_not_found</span><span class="p">(</span><span class="n">errctx</span><span class="o">=</span><span class="s2">&quot;Registry.pyobject&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="o">=</span><span class="s2">&quot;Registry path </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">moniker</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hKey</span></div>

<div class="viewcode-block" id="Registry.as_string"><a class="viewcode-back" href="../registry.html#registry.Registry.as_string">[docs]</a>    <span class="k">def</span> <span class="nf">as_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">moniker</span></div>

<div class="viewcode-block" id="Registry.security"><a class="viewcode-back" href="../registry.html#registry.Registry.security">[docs]</a>    <span class="k">def</span> <span class="nf">security</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">security</span><span class="o">.</span><span class="n">Security</span><span class="o">.</span><span class="n">DEFAULT_OPTIONS</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For a security request, hand off to the :meth:`~security.Security.from_object` method</span>
<span class="sd">        of the :class:`security.Security` object, specifying a registry key as the object type.</span>
<span class="sd">        Most commonly used as a context manager for security operations::</span>

<span class="sd">            from winsys import registry</span>
<span class="sd">            with registry.registry(r&quot;hklm\software\python&quot;).security() as s:</span>
<span class="sd">                print s.owner</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">security</span><span class="o">.</span><span class="n">Security</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(),</span>
            <span class="n">object_type</span><span class="o">=</span><span class="n">security</span><span class="o">.</span><span class="n">SE_OBJECT_TYPE</span><span class="o">.</span><span class="n">REGISTRY_KEY</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine whether the registry key exists or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hKey</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moniker</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">hKey</span><span class="p">)</span>
    <span class="fm">__bool__</span> <span class="o">=</span> <span class="n">__nonzero__</span>

    <span class="k">def</span> <span class="nf">dumped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;access: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">access</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;keys:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped_list</span><span class="p">((</span><span class="n">key</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">ignore_access_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="n">level</span><span class="p">))</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;values:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;(Default)&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">ignore_access_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)),</span> <span class="n">level</span><span class="p">))</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;security:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">security</span><span class="p">()</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="n">level</span><span class="p">),</span> <span class="n">level</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumped</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">level</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow attribute access (key.value) by trying for a value</span>
<span class="sd">        first and then falling back to a key and finally raising</span>
<span class="sd">        AttributeError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_not_found</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_not_found</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span>
    <span class="fm">__getitem__</span> <span class="o">=</span> <span class="fm">__getattr__</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow attribute assignment by assigning a value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="fm">__setitem__</span> <span class="o">=</span> <span class="fm">__setattr__</span>

    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">del_value</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_not_found</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_not_found</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span>
    <span class="fm">__delitem__</span> <span class="o">=</span> <span class="fm">__delattr__</span>

<div class="viewcode-block" id="Registry.get_value"><a class="viewcode-back" href="../registry.html#registry.Registry.get_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the key&#39;s value corresponding to name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegQueryValueEx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Registry.get_value_type"><a class="viewcode-back" href="../registry.html#registry.Registry.get_value_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_value_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the type of the key&#39;s value corresponding to name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegQueryValueEx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span></div>

<div class="viewcode-block" id="Registry.get_key"><a class="viewcode-back" href="../registry.html#registry.Registry.get_key">[docs]</a>    <span class="k">def</span> <span class="nf">get_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Registry instance corresponding to the key&#39;s subkey name</span>

<span class="sd">        :param name: a registry relative path (may be a single name or a backslash-separated path</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">+</span> <span class="n">name</span></div>

<div class="viewcode-block" id="Registry.set_value"><a class="viewcode-back" href="../registry.html#registry.Registry.set_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to set one of the key&#39;s named values. If type is</span>
<span class="sd">        None, then if the value already exists under the key its</span>
<span class="sd">        current type is assumed; otherwise a guess is made at</span>
<span class="sd">        the datatype as follows:</span>

<span class="sd">        * If the value is an int, use DWORD</span>
<span class="sd">        * If the value is a list, use MULTI_SZ</span>
<span class="sd">        * If the value has an even number of percent signs, use EXPAND_SZ</span>
<span class="sd">        * Otherwise, use REG_SZ</span>

<span class="sd">        This is a very naive approach, and will falter if, for example,</span>
<span class="sd">        a string is passed which can be converted into a number, or a string</span>
<span class="sd">        with 2 percent signs which don&#39;t refer to an env var.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">_guess_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">REGISTRY_VALUE_TYPE</span><span class="o">.</span><span class="n">REG_DWORD</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">REGISTRY_VALUE_TYPE</span><span class="o">.</span><span class="n">REG_MULTI_SZ</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;%&quot;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">REGISTRY_VALUE_TYPE</span><span class="o">.</span><span class="n">REG_EXPAND_SZ</span>
            <span class="k">return</span> <span class="n">REGISTRY_VALUE_TYPE</span><span class="o">.</span><span class="n">REG_SZ</span>

        <span class="nb">type</span> <span class="o">=</span> <span class="n">REGISTRY_VALUE_TYPE</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegQueryValueEx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(),</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_not_found</span><span class="p">:</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="n">_guess_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegSetValueEx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(),</span> <span class="n">label</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Registry.del_value"><a class="viewcode-back" href="../registry.html#registry.Registry.del_value">[docs]</a>    <span class="k">def</span> <span class="nf">del_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Removed the value identified by label from this registry key&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegDeleteValue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(),</span> <span class="n">label</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">DEFAULT_ACCESS</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Treat the string param as a moniker and return the corresponding</span>
<span class="sd">        registry key and value name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">computer</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">_parse_moniker</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="n">accept_value</span><span class="p">)</span>
        <span class="n">moniker</span> <span class="o">=</span> <span class="n">REGISTRY_HIVE</span><span class="o">.</span><span class="n">name_from_value</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">sep</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">computer</span><span class="p">:</span>
            <span class="n">hRoot</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegConnectRegistry</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">computer</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span> <span class="k">else</span> <span class="n">computer</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hRoot</span> <span class="o">=</span> <span class="n">root</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">computer</span><span class="p">:</span>
                <span class="n">moniker</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="si">%s</span><span class="s2">\</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">computer</span><span class="p">,</span> <span class="n">moniker</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegOpenKeyEx</span><span class="p">,</span> <span class="n">hRoot</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_access</span><span class="p">(</span><span class="n">access</span><span class="p">)),</span> <span class="n">moniker</span><span class="p">,</span> <span class="n">value</span>
        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_not_found</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">moniker</span><span class="p">,</span> <span class="n">value</span>

<div class="viewcode-block" id="Registry.from_string"><a class="viewcode-back" href="../registry.html#registry.Registry.from_string">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">DEFAULT_ACCESS</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Treat the string param as a moniker return either a key</span>
<span class="sd">        or a value. This is mostly used via the :func:`registry` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hKey</span><span class="p">,</span> <span class="n">moniker</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_string</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">accept_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">moniker</span><span class="p">,</span> <span class="n">access</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">moniker</span><span class="p">,</span> <span class="n">access</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="registry"><a class="viewcode-back" href="../registry.html#registry.registry">[docs]</a><span class="k">def</span> <span class="nf">registry</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">Registry</span><span class="o">.</span><span class="n">DEFAULT_ACCESS</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Factory function for the Registry class.</span>

<span class="sd">    :param root: any of None, a Registry instance, or a moniker string</span>
<span class="sd">    :param access: an integer bitmask or an :data:`Registry.ACCESS` string</span>
<span class="sd">    :returns: a :class:`Registry` object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">Registry</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">root</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Registry</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">access</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="n">accept_value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">x_registry</span><span class="p">(</span><span class="n">errctx</span><span class="o">=</span><span class="s2">&quot;registry&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="o">=</span><span class="s2">&quot;root must be None, an existing key or a moniker&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="values"><a class="viewcode-back" href="../registry.html#registry.values">[docs]</a><span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ignore_access_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_want_types</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield the values of a registry key as (name, value). This is convenient</span>
<span class="sd">    for, eg, populating a dictionary::</span>

<span class="sd">        from winsys import registry</span>

<span class="sd">        com3 = registry.registry(r&quot;HKLM\Software\Microsoft\Com3&quot;)</span>
<span class="sd">        com3_values = dict(com3.itervalues())</span>

<span class="sd">    :param root: anything accepted by :func:`registry`</span>
<span class="sd">    :param ignore_access_errors: if True, will keep on iterating even if access denied</span>
<span class="sd">    :param _want_types: (internal) used when, eg, copying keys exactly</span>
<span class="sd">    :returns: yields (name, value) for every value under :const:`root`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hKey</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">pyobject</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_access_denied</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ignore_access_errors</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegEnumValue</span><span class="p">,</span> <span class="n">hKey</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_want_types</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_access_denied</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ignore_access_errors</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>
<span class="n">itervalues</span> <span class="o">=</span> <span class="n">values</span>

<div class="viewcode-block" id="keys"><a class="viewcode-back" href="../registry.html#registry.keys">[docs]</a><span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ignore_access_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield the subkeys of a registry key as :class:`Registry` objects</span>

<span class="sd">    :param root: anything accepted by :func:`registry`</span>
<span class="sd">    :param ignore_access_errors: if True, will keep on iterating even if access denied</span>
<span class="sd">    :returns: yield :class:`Registry` objects for each key under `root`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hRoot</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">pyobject</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_access_denied</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ignore_access_errors</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">subname</span><span class="p">,</span> <span class="n">reserved</span><span class="p">,</span> <span class="n">subclass</span><span class="p">,</span> <span class="n">written_at</span> <span class="ow">in</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegEnumKeyExW</span><span class="p">,</span> <span class="n">hRoot</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">registry</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">moniker</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">subname</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">x_access_denied</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ignore_access_errors</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span></div>
<span class="n">iterkeys</span> <span class="o">=</span> <span class="n">keys</span>

<div class="viewcode-block" id="copy"><a class="viewcode-back" href="../registry.html#registry.copy">[docs]</a><span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">from_key</span><span class="p">,</span> <span class="n">to_key</span><span class="p">,</span> <span class="n">use_access</span><span class="o">=</span><span class="s2">&quot;F&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy one registry key to another, returning the target. If the</span>
<span class="sd">    target doesn&#39;t already exist it will be created.</span>

<span class="sd">    :param from_key: anything accepted by :func:`registry`</span>
<span class="sd">    :param to_key: anything accepted by :func:`registry`</span>
<span class="sd">    :returns: a :class:`Registry` object for `to_key`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span><span class="n">from_key</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span><span class="n">to_key</span><span class="p">,</span> <span class="n">access</span><span class="o">=</span><span class="n">use_access</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
        <span class="n">target</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">subkeys</span><span class="p">,</span> <span class="n">subvalues</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">_want_types</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">target_root</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span>
                <span class="n">target</span><span class="o">.</span><span class="n">moniker</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">moniker</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">moniker</span><span class="p">),</span>
                <span class="n">access</span><span class="o">=</span><span class="n">use_access</span><span class="p">,</span>
                <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">subkeys</span><span class="p">:</span>
            <span class="n">target_key</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span>
                <span class="n">target</span><span class="o">.</span><span class="n">moniker</span> <span class="o">+</span> <span class="n">utils</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">moniker</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">moniker</span><span class="p">),</span>
                <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">access</span><span class="o">=</span><span class="n">use_access</span>
            <span class="p">)</span>
            <span class="n">target_key</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">subvalues</span><span class="p">:</span>
            <span class="n">target_root</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">target</span></div>

<div class="viewcode-block" id="delete"><a class="viewcode-back" href="../registry.html#registry.delete">[docs]</a><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">subkey</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete a registry key and all its subkeys</span>

<span class="sd">    The common use for this will be to delete a key itself.</span>
<span class="sd">    The optional subkey param is useful when this is invoked</span>
<span class="sd">    as a method of a :class:`Registry` object and it&#39;s convenient</span>
<span class="sd">    to remove one of its subkeys::</span>

<span class="sd">        from winsys import registry</span>
<span class="sd">        ws = registry.registry(r&quot;hklm\software\winsys&quot;)</span>
<span class="sd">        ws.create()</span>
<span class="sd">        for subkey in [&quot;winsys1&quot;, &quot;winsys2&quot;, &quot;winsys3&quot;]:</span>
<span class="sd">            ws.create(subkey)</span>
<span class="sd">        for key in ws.iterkeys():</span>
<span class="sd">            print key</span>
<span class="sd">        for subkey in [&quot;winsys1&quot;, &quot;winsys2&quot;, &quot;winsys3&quot;]:</span>
<span class="sd">            ws.delete(subkey)</span>
<span class="sd">        ws.delete()</span>

<span class="sd">    :param root: anything accepted by :func:`registry`</span>
<span class="sd">    :param subkey: anything accepted by :meth:`Registry.get_key`</span>
<span class="sd">    :returns: a :class:`Registry` object for `root`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">subkey</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">key</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
        <span class="n">k</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">win32api</span><span class="o">.</span><span class="n">RegDeleteKey</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">pyobject</span><span class="p">(),</span> <span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">key</span></div>

<div class="viewcode-block" id="create"><a class="viewcode-back" href="../registry.html#registry.create">[docs]</a><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">subkey</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">sec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a key and apply specific security to it, returning the</span>
<span class="sd">    key created. Note that a colon in the key name is treated as part</span>
<span class="sd">    of the name not as a value indicator. Any parts of the path not</span>
<span class="sd">    already existing will be created as needed::</span>

<span class="sd">        from winsys import registry, security</span>
<span class="sd">        sec = security.Security(dacl=[(&quot;&quot;, &quot;F&quot;, &quot;ALLOW&quot;)])</span>
<span class="sd">        registry.create(r&quot;hklm\software\winsys\test&quot;, sec=sec)</span>
<span class="sd">        registry.registry(r&quot;hklm\software\winsys\test&quot;).dump()</span>

<span class="sd">    :param root: anything accepted by :func:`registry`</span>
<span class="sd">    :param subkey: anything accepted by :meth:`Registry.get_key`</span>
<span class="sd">    :param sec: a :class:`security.Security` instance or None</span>
<span class="sd">    :returns: a :class:`Registry` object for `root`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="n">subkey</span><span class="p">)</span>
    <span class="n">computer0</span><span class="p">,</span> <span class="n">root0</span><span class="p">,</span> <span class="n">path0</span><span class="p">,</span> <span class="n">value0</span> <span class="o">=</span> <span class="n">_parse_moniker</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">moniker</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">parts</span> <span class="o">=</span> <span class="n">path0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
        <span class="n">computer</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">_parse_moniker</span><span class="p">(</span><span class="n">create_moniker</span><span class="p">(</span><span class="n">computer0</span><span class="p">,</span> <span class="n">root0</span><span class="p">,</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])),</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">computer</span><span class="p">:</span>
            <span class="n">hRoot</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">win32api</span><span class="o">.</span><span class="n">RegConnectRegistry</span><span class="p">,</span> <span class="n">computer</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hRoot</span> <span class="o">=</span> <span class="n">root</span>
        <span class="n">wrapped</span><span class="p">(</span>
            <span class="n">win32api</span><span class="o">.</span><span class="n">RegCreateKeyEx</span><span class="p">,</span>
            <span class="n">Key</span><span class="o">=</span><span class="n">hRoot</span><span class="p">,</span>
            <span class="n">SubKey</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="n">samDesired</span><span class="o">=</span><span class="n">Registry</span><span class="o">.</span><span class="n">_access</span><span class="p">(</span><span class="n">Registry</span><span class="o">.</span><span class="n">DEFAULT_ACCESS</span><span class="p">),</span>
            <span class="n">SecurityAttributes</span><span class="o">=</span><span class="n">sec</span><span class="o">.</span><span class="n">pyobject</span><span class="p">()</span> <span class="k">if</span> <span class="n">sec</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">key</span></div>

<div class="viewcode-block" id="walk"><a class="viewcode-back" href="../registry.html#registry.walk">[docs]</a><span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ignore_access_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_want_types</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mimic the os.walk functionality for the registry, starting at root and</span>
<span class="sd">    yielding (key, subkeys, values) for each key visited. subkeys and values are</span>
<span class="sd">    themselves generators.</span>

<span class="sd">    :param root: anything accepted by :func:`registry`</span>
<span class="sd">    :param ignore_access_errors: if True, will keep on iterating even if access denied</span>
<span class="sd">    :param _want_types: (internal) indicates whether value types are returned as well as values</span>
<span class="sd">    :returns: yields `key`, `subkeys`, `values` recursively for every key under `root`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">yield</span> <span class="p">(</span>
        <span class="n">root</span><span class="p">,</span>
        <span class="n">root</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">ignore_access_errors</span><span class="o">=</span><span class="n">ignore_access_errors</span><span class="p">),</span>
        <span class="n">root</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">ignore_access_errors</span><span class="o">=</span><span class="n">ignore_access_errors</span><span class="p">,</span> <span class="n">_want_types</span><span class="o">=</span><span class="n">_want_types</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">subkey</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">ignore_access_errors</span><span class="o">=</span><span class="n">ignore_access_errors</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">ignore_access_errors</span><span class="o">=</span><span class="n">ignore_access_errors</span><span class="p">,</span> <span class="n">_want_types</span><span class="o">=</span><span class="n">_want_types</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">result</span></div>

<div class="viewcode-block" id="flat"><a class="viewcode-back" href="../registry.html#registry.flat">[docs]</a><span class="k">def</span> <span class="nf">flat</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ignore_access_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Yield a flattened version the tree rooted at root.</span>

<span class="sd">    :param root: anything accepted by :func:`registry`</span>
<span class="sd">    :param ignore_access_errors: if True, will keep on iterating even if access denied</span>
<span class="sd">    :returns: yields `key` and then `value` items for each key under `root`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">subkeys</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ignore_access_errors</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">key</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">value</span></div>

<div class="viewcode-block" id="parent"><a class="viewcode-back" href="../registry.html#registry.parent">[docs]</a><span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a registry key&#39;s parent key if it exists</span>

<span class="sd">    :param key: anything accepted by :func:`registry`</span>
<span class="sd">    :returns: a :class:`Registry` object representing the parent of key</span>
<span class="sd">    :raises: :exc:`x_registry` if no parent exists (eg for a hive)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">computer</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">_parse_moniker</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">moniker</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">parent_moniker</span> <span class="o">=</span> <span class="n">create_moniker</span><span class="p">(</span><span class="n">computer</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">pcomputer</span><span class="p">,</span> <span class="n">proot</span><span class="p">,</span> <span class="n">ppath</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="n">_parse_moniker</span><span class="p">(</span><span class="n">parent_moniker</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ppath</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">registry</span><span class="p">(</span><span class="n">parent_moniker</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">access</span><span class="p">,</span> <span class="n">accept_value</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">x_registry</span><span class="p">(</span><span class="n">errctx</span><span class="o">=</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> has no parent&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="o">.</span><span class="n">moniker</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">hklm</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">registry</span><span class="p">(</span><span class="s2">&quot;hklm&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">hkcu</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">registry</span><span class="p">(</span><span class="s2">&quot;hkcu&quot;</span><span class="p">)</span>

<span class="n">Registry</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>
<span class="n">Registry</span><span class="o">.</span><span class="n">itervalues</span> <span class="o">=</span> <span class="n">itervalues</span>
<span class="n">Registry</span><span class="o">.</span><span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span>
<span class="n">Registry</span><span class="o">.</span><span class="n">iterkeys</span> <span class="o">=</span> <span class="n">iterkeys</span>
<span class="n">Registry</span><span class="o">.</span><span class="fm">__iter__</span> <span class="o">=</span> <span class="n">keys</span>
<span class="n">Registry</span><span class="o">.</span><span class="n">delete</span> <span class="o">=</span> <span class="n">delete</span>
<span class="n">Registry</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">create</span>
<span class="n">Registry</span><span class="o">.</span><span class="n">walk</span> <span class="o">=</span> <span class="n">walk</span>
<span class="n">Registry</span><span class="o">.</span><span class="n">flat</span> <span class="o">=</span> <span class="n">flat</span>
<span class="n">Registry</span><span class="o">.</span><span class="n">copy</span> <span class="o">=</span> <span class="n">copy</span>
<span class="n">Registry</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/cpython2.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../contents.html">WinSys 1.0beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013, Tim Golden.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.2.
    </div>
  </body>
</html>